<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®‰å®šç‰ˆï¼‰</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">

<style>
  body { font-family: 'Noto Sans JP', sans-serif; }
  #interactive { height: 240px; background:#000; border-radius:8px; overflow:hidden }
  #interactive video { width:100%; height:100%; object-fit:cover }
</style>
</head>

<body class="bg-slate-100 min-h-screen">

<header class="bg-white shadow p-4 flex justify-between items-center">
  <h1 class="font-bold text-xl">ğŸ“š è”µæ›¸ç®¡ç†</h1>
  <button onclick="openNewModal()" class="bg-slate-800 text-white px-4 py-2 rounded">
    ï¼‹ ç™»éŒ²
  </button>
</header>

<main class="p-4 max-w-6xl mx-auto">
  <div id="bookGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
  <div id="emptyMsg" class="hidden text-center text-slate-400 mt-10">
    ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
  </div>
</main>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
  <div class="bg-white w-full max-w-md rounded-xl p-4">

    <h2 class="font-bold mb-3">æ›¸ç±ç™»éŒ² / ç·¨é›†</h2>

    <button onclick="startScanner()" class="w-full border p-3 rounded mb-3">
      ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
    </button>

    <div id="scanner" class="hidden mb-3">
      <div id="interactive"></div>
      <button onclick="stopScanner()" class="w-full text-red-500 mt-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <input id="isbn" placeholder="ISBN" class="w-full border p-2 mb-2">
    <button onclick="lookupISBN(event)" class="w-full bg-slate-200 p-2 rounded mb-2">
      ISBNæƒ…å ±å–å¾—
    </button>

    <input id="mcNumber" placeholder="ç®¡ç†ç•ªå·ï¼ˆæ•°å­—10æ¡ï¼‰" class="w-full border p-2 mb-2" maxlength="10" inputmode="numeric">
    <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="w-full border p-2 mb-2">
    <input id="author" placeholder="è‘—è€…" class="w-full border p-2 mb-2">

    <input type="hidden" id="cover">
    <div id="coverPreview" class="h-40 border flex items-center justify-center mb-3 text-slate-400">
      No Image
    </div>

    <div class="flex gap-2">
      <button onclick="closeModal()" class="flex-1 border p-2 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button onclick="saveBook()" class="flex-1 bg-slate-800 text-white p-2 rounded">
        ä¿å­˜
      </button>
    </div>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  doc, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* Firebase */
const app = initializeApp({
  apiKey: "AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
  authDomain: "library-management-tool-31dcd.firebaseapp.com",
  projectId: "library-management-tool-31dcd"
});
const db = getFirestore(app);

/* DOM */
const grid = document.getElementById("bookGrid");
const emptyMsg = document.getElementById("emptyMsg");

let books = [];
let editingId = null;

/* ğŸ”¥ å®‰å®šç‰ˆ onSnapshot */
onSnapshot(collection(db, "books"), snap => {
  books = snap.docs.map(d => {
    const data = d.data();

    let sortDate = new Date(0);
    if (data.createdAt?.toDate) sortDate = data.createdAt.toDate();
    else if (data.updatedAt?.toDate) sortDate = data.updatedAt.toDate();

    return { id: d.id, ...data, _sortDate: sortDate };
  });

  books.sort((a,b) => b._sortDate - a._sortDate);
  render();
});

function render(){
  grid.innerHTML = "";

  if(books.length === 0){
    emptyMsg.classList.remove("hidden");
    return;
  } else {
    emptyMsg.classList.add("hidden");
  }

  books.forEach(b=>{
    grid.innerHTML += `
      <div class="bg-white p-2 rounded shadow">
        <div class="h-32 bg-slate-100 mb-2 flex items-center justify-center">
          ${b.cover ? `<img src="${b.cover}" class="h-full object-contain">` : "No Image"}
        </div>
        <p class="font-bold text-sm">${b.title || ""}</p>
        <p class="text-xs text-slate-400">${b.author || ""}</p>
        <p class="text-[10px] text-slate-500">ç®¡ç†ç•ªå·ï¼š${b.mcNumber || "-"}</p>
        <div class="flex gap-2 text-xs mt-2">
          <button onclick="editBook('${b.id}')" class="flex-1 border rounded py-1">ç·¨é›†</button>
          <button onclick="deleteBook('${b.id}')" class="flex-1 border rounded py-1 text-red-500">å‰Šé™¤</button>
        </div>
      </div>
    `;
  });
}

/* CRUD */
window.saveBook = async () => {
  const mc = mcNumber.value.trim();
  if(!/^\d{10}$/.test(mc)){
    alert("ç®¡ç†ç•ªå·ã¯10æ¡ã®æ•°å­—ã§ã™");
    return;
  }

  const data = {
    isbn: isbn.value,
    mcNumber: mc,
    title: title.value,
    author: author.value,
    cover: cover.value,
    updatedAt: new Date()
  };

  if(editingId){
    await updateDoc(doc(db,"books",editingId), data);
  } else {
    await addDoc(collection(db,"books"), { ...data, createdAt:new Date() });
  }
  closeModal();
};

window.editBook = id => {
  const b = books.find(x=>x.id===id);
  if(!b) return;

  editingId = id;
  isbn.value = b.isbn || "";
  mcNumber.value = b.mcNumber || "";
  title.value = b.title || "";
  author.value = b.author || "";
  cover.value = b.cover || "";
  coverPreview.innerHTML = b.cover ? `<img src="${b.cover}" class="h-full object-contain">` : "No Image";
  openModal();
};

window.deleteBook = async id => {
  if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    await deleteDoc(doc(db,"books",id));
  }
};

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
window.openNewModal = () => {
  resetForm();
  openModal();
};

function resetForm(){
  editingId = null;
  isbn.value = "";
  mcNumber.value = "";
  title.value = "";
  author.value = "";
  cover.value = "";
  coverPreview.innerHTML = "No Image";
}

window.openModal = () => modal.classList.replace("hidden","flex");
window.closeModal = () => {
  stopScanner();
  modal.classList.replace("flex","hidden");
};

/* Scanner */
let scanning=false;
window.startScanner = () => {
  scanner.classList.remove("hidden");
  Quagga.init({
    inputStream:{ type:"LiveStream", target:"#interactive", constraints:{facingMode:"environment"} },
    decoder:{ readers:["ean_reader"] }
  },err=>{
    if(err){ alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—"); return; }
    Quagga.start(); scanning=true;
  });

  Quagga.onDetected(r=>{
    const code = r.codeResult.code;
    if(/^97[89]\d{10}$/.test(code)){
      isbn.value = code;
      stopScanner();
      lookupISBN();
    }
  });
};

window.stopScanner = () => {
  if(scanning){ Quagga.stop(); Quagga.offDetected(); }
  scanning=false;
  scanner.classList.add("hidden");
};

/* ISBN */
window.lookupISBN = async (event) => {
  const btn = event?.target;
  if(btn){ btn.disabled=true; btn.textContent="å–å¾—ä¸­..."; }

  const i = isbn.value.replace(/\D/g,"");
  let t="",a="",c="";
  try{
    const r = await fetch(`https://api.openbd.jp/v1/get?isbn=${i}`);
    const d = await r.json();
    if(d[0]?.summary){
      t=d[0].summary.title||"";
      a=d[0].summary.author||"";
      c=d[0].summary.cover||"";
    }
    if(!c){
      const gr = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${i}`);
      const gd = await gr.json();
      c=gd.items?.[0]?.volumeInfo?.imageLinks?.thumbnail||"";
    }
    if(c.startsWith("http://")) c=c.replace("http://","https://");
  }catch(e){
    alert("å–å¾—å¤±æ•—");
  }

  title.value=t;
  author.value=a;
  cover.value=c;
  coverPreview.innerHTML=c?`<img src="${c}" class="h-full object-contain">`:"No Image";

  if(btn){ btn.disabled=false; btn.textContent="ISBNæƒ…å ±å–å¾—"; }
};
</script>
</body>
</html>
