<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Pro</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

<style>
body { font-family: "Noto Sans JP", sans-serif; background:#f8fafc; }
video {
  width:100%;
  height:240px;
  background:#000;
  object-fit:cover;
  border-radius:12px;
}
.scan-overlay {
  position:absolute;
  inset:20% 10%;
  border:2px solid red;
  pointer-events:none;
}
</style>
</head>

<body class="min-h-screen flex flex-col">

<header class="bg-white border-b h-16 flex items-center px-4">
  <h1 class="font-bold text-xl">ğŸ“š è”µæ›¸ç®¡ç†</h1>
</header>

<main class="flex-grow max-w-6xl mx-auto p-4 w-full">

<div class="flex gap-3 mb-4">
  <input id="searchInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è‘—è€…ãƒ»ISBNæ¤œç´¢"
    class="flex-grow border rounded-xl px-4 py-3">
  <button id="openBtn"
    class="bg-slate-800 text-white px-5 rounded-xl font-bold">
    ï¼‹ç™»éŒ²
  </button>
</div>

<div id="bookGrid"
  class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

</main>

<!-- Modal -->
<div id="modal"
  class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
<div class="bg-white w-full max-w-lg rounded-2xl p-6">

<h2 class="font-bold text-lg mb-3">æ›¸ç±ç™»éŒ²</h2>

<button id="scanBtn"
  class="w-full border-2 border-dashed py-4 rounded-xl font-bold mb-4">
  ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
</button>

<div id="scannerBox" class="hidden relative mb-4">
  <video id="video" playsinline muted></video>
  <div class="scan-overlay"></div>
  <button id="cancelScan"
    class="text-red-500 font-bold w-full mt-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<input id="isbnInput" placeholder="ISBN"
  class="w-full border px-4 py-2 rounded-xl mb-2">
<input id="titleInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ«"
  class="w-full border px-4 py-2 rounded-xl mb-2 font-bold">
<input id="authorInput" placeholder="è‘—è€…"
  class="w-full border px-4 py-2 rounded-xl mb-2">

<input type="hidden" id="coverUrl">

<div id="coverPreview"
  class="h-40 bg-slate-100 rounded-xl flex items-center justify-center mb-4 text-slate-400">
  è¡¨ç´™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
</div>

<div class="flex gap-3">
  <button id="closeBtn"
    class="flex-1 bg-slate-200 py-3 rounded-xl font-bold">
    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  </button>
  <button id="saveBtn"
    class="flex-1 bg-slate-800 text-white py-3 rounded-xl font-bold">
    ç™»éŒ²
  </button>
</div>

</div>
</div>

<script type="module">
/* ========= util ========= */
const $ = id => document.getElementById(id);

/* ========= ZXing ========= */
import { BrowserMultiFormatReader }
from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.4/+esm";

/* ========= Firebase ========= */
import { initializeApp }
from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously }
from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc,
  onSnapshot, query, orderBy
}
from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
  authDomain: "library-management-tool-31dcd.firebaseapp.com",
  projectId: "library-management-tool-31dcd"
};

initializeApp(firebaseConfig);
signInAnonymously(getAuth());
const db = getFirestore();

/* ========= State ========= */
const reader = new BrowserMultiFormatReader();
let controls = null;
let books = [];

/* ========= Firestore ========= */
onSnapshot(
  query(collection(db,"books"), orderBy("createdAt","desc")),
  snap => {
    books = snap.docs.map(d => d.data());
    render();
  }
);

/* ========= Render ========= */
function render(){
  const q = $("searchInput").value.toLowerCase();
  $("bookGrid").innerHTML = "";

  books.filter(b =>
    !q ||
    b.title.toLowerCase().includes(q) ||
    b.author.toLowerCase().includes(q) ||
    b.isbn.includes(q)
  ).forEach(b=>{
    $("bookGrid").insertAdjacentHTML("beforeend",`
      <div class="bg-white rounded-xl p-4 shadow">
        <div class="h-48 bg-slate-100 rounded mb-2 flex items-center justify-center overflow-hidden">
          ${b.coverUrl ? `<img src="${b.coverUrl}" class="h-full w-full object-contain">` : "No Image"}
        </div>
        <div class="font-bold">${b.title}</div>
        <div class="text-sm text-slate-500">${b.author}</div>
        <div class="text-xs text-slate-400">${b.isbn}</div>
      </div>
    `);
  });
}
$("searchInput").addEventListener("input", render);

/* ========= Modal ========= */
$("openBtn").onclick = () => $("modal").classList.replace("hidden","flex");
$("closeBtn").onclick = closeModal;

/* ========= Scannerï¼ˆèƒŒé¢ã‚«ãƒ¡ãƒ©å¼·åˆ¶ï¼‰ ========= */
$("scanBtn").onclick = startScanner;
$("cancelScan").onclick = stopScanner;

async function startScanner(){
  stopScanner();
  $("scannerBox").classList.remove("hidden");

  // Safariæç”»å¾…ã¡
  await new Promise(r => requestAnimationFrame(r));
  await new Promise(r => setTimeout(r, 60));

  try {
    /* â‘  ã¾ãš environment ã§è¨±å¯å–å¾—ï¼ˆiOSå¿…é ˆï¼‰ */
    const tmp = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ exact:"environment" } },
      audio:false
    });
    tmp.getTracks().forEach(t=>t.stop());

    /* â‘¡ ã‚«ãƒ¡ãƒ©ä¸€è¦§å–å¾— */
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videos = devices.filter(d=>d.kind==="videoinput");

    /* â‘¢ èƒŒé¢ã‚«ãƒ¡ãƒ©ç‰¹å®šï¼ˆiPhoneå¯¾å¿œï¼‰ */
    const backCam =
      videos.find(d=>/back|rear|environment/i.test(d.label))
      || videos[videos.length-1];

    /* â‘£ èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’ deviceId ã§èµ·å‹• */
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ deviceId:{ exact: backCam.deviceId } },
      audio:false
    });

    const video = $("video");
    video.srcObject = stream;
    video.setAttribute("playsinline","");
    video.muted = true;
    await video.play();

    /* â‘¤ ZXing èª­ã¿å–ã‚Š */
    controls = await reader.decodeFromVideoDevice(
      backCam.deviceId,
      video,
      result=>{
        if(result){
          const code = result.getText();
          if(/^97[89]\d{10}$/.test(code)){
            $("isbnInput").value = code;
            stopScanner();
            lookupISBN(code);
          }
        }
      }
    );

  } catch (e) {
    alert("èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ï¼ˆSafariè¨­å®šã‚’ç¢ºèªï¼‰");
    stopScanner();
  }
}

function stopScanner(){
  if(controls){ controls.stop(); controls=null; }
  const v = $("video");
  if(v.srcObject){
    v.srcObject.getTracks().forEach(t=>t.stop());
    v.srcObject=null;
  }
  $("scannerBox").classList.add("hidden");
}

function closeModal(){
  stopScanner();
  $("modal").classList.replace("flex","hidden");
}

/* ========= OpenBD ========= */
async function lookupISBN(isbn){
  const r = await fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`);
  const d = await r.json();
  if(d && d[0]?.summary){
    const s = d[0].summary;
    $("titleInput").value = s.title || "";
    $("authorInput").value = s.author || "";
    $("coverUrl").value = s.cover || "";
    $("coverPreview").innerHTML =
      s.cover ? `<img src="${s.cover}" class="h-full w-full object-contain">` : "è¡¨ç´™ãªã—";
  }
}

/* ========= Save ========= */
$("saveBtn").onclick = async ()=>{
  await addDoc(collection(db,"books"),{
    isbn: $("isbnInput").value,
    title: $("titleInput").value,
    author: $("authorInput").value || "ä¸æ˜",
    coverUrl: $("coverUrl").value || "",
    createdAt: new Date()
  });
  closeModal();
};
</script>

</body>
</html>
