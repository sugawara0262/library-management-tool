<!-- 省略なし：そのまま使える完全版 -->
<!-- ★変更点にはコメントで【改善】を付けています -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, onSnapshot,
    doc, updateDoc, deleteDoc, where, getDocs
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
    authDomain: "library-management-tool-31dcd.firebaseapp.com",
    projectId: "library-management-tool-31dcd"
  });
  const db = getFirestore(app);

  let allBooks = [];
  let editingId = null;

  /* ===== Firestore listener（並び替え：改善②） ===== */
  onSnapshot(collection(db, "books"), snap => {
    allBooks = snap.docs.map(d => {
      const data = d.data();
      return {
        id: d.id,
        ...data,
        createdAt: data.createdAt?.toDate?.() || new Date(0)
      };
    });

    // ★クライアントサイドソート（新しい順）
    allBooks.sort((a, b) => b.createdAt - a.createdAt);
    applySearch();
  });

  /* ===== 新規登録用（改善①） ===== */
  window.openNewModal = () => {
    resetForm();
    openModal();
  };

  function resetForm() {
    editingId = null;
    inpIsbn.value = "";
    inpMcNumber.value = "";
    inpTitle.value = "";
    inpAuthor.value = "";
    inpCover.value = "";
    coverPreview.innerHTML = `<span class="text-sm text-slate-400">No Image</span>`;
  }

  /* ===== ISBN検索 Loading（改善③・安全版） ===== */
  window.lookupISBN = async () => {
    const i = inpIsbn.value.replace(/\D/g, "");
    if (i.length !== 13) {
      alert("ISBNは13桁です");
      return;
    }

    const btn = document.getElementById("btnLookup");
    btn.disabled = true;
    btn.textContent = "検索中...";

    try {
      let t = "", a = "", c = "";

      const r = await fetch(`https://api.openbd.jp/v1/get?isbn=${i}`);
      const d = await r.json();
      if (d[0]?.summary) {
        t = d[0].summary.title || "";
        a = d[0].summary.author || "";
        c = d[0].summary.cover || "";
      }

      if (!c) {
        const g = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${i}`);
        const gd = await g.json();
        const info = gd.items?.[0]?.volumeInfo;
        if (info) {
          if (!t) t = info.title || "";
          if (!a) a = info.authors?.join(", ") || "";
          c = info.imageLinks?.thumbnail || "";
        }
      }

      if (c.startsWith("http://")) c = c.replace("http://", "https://");

      inpTitle.value = t;
      inpAuthor.value = a;
      inpCover.value = c;
      coverPreview.innerHTML = c
        ? `<img src="${c}" class="h-full w-full object-contain">`
        : `<span class="text-sm text-slate-400">No Image</span>`;

    } catch (e) {
      alert("情報取得に失敗しました");
      console.error(e);
    } finally {
      btn.disabled = false;
      btn.textContent = "取得";
    }
  };
</script>
