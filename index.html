<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è”µæ›¸ç®¡ç†ï¼‹æ£šå¸</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">

<style>
body { font-family: 'Noto Sans JP', sans-serif; }
#interactive { height:220px; background:#000; border-radius:10px; overflow:hidden }
#interactive video { width:100%; height:100%; object-fit:cover }
.scan-line{position:absolute;left:10%;right:10%;top:50%;height:2px;background:red}
</style>
</head>

<body class="bg-slate-100 min-h-screen">

<header class="bg-white shadow p-4 flex justify-between items-center">
  <h1 class="font-bold text-lg">ğŸ“š è”µæ›¸ç®¡ç†</h1>
  <div class="flex gap-2 items-center">
    <label class="text-sm flex items-center gap-1">
      <input type="checkbox" id="toggleInventory">
      æ£šå¸ãƒ¢ãƒ¼ãƒ‰
    </label>
    <button onclick="openModal()" class="bg-slate-800 text-white px-4 py-2 rounded">
      ï¼‹ ç™»éŒ²
    </button>
  </div>
</header>

<main class="p-4 max-w-6xl mx-auto">
  <div id="scannerBox" class="hidden mb-4 relative">
    <div id="interactive"><div class="scan-line"></div></div>
    <p class="text-center text-xs text-slate-500 mt-1">æœ¬ã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</p>
  </div>
  <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
</main>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
  <div class="bg-white w-full max-w-md rounded-xl p-4">
    <h2 class="font-bold mb-3">æ›¸ç±ç™»éŒ²</h2>

    <input id="isbn" placeholder="ISBN" class="w-full border p-2 mb-2">
    <input id="mc" placeholder="ç®¡ç†ç•ªå·ï¼ˆ10æ¡ï¼‰" class="w-full border p-2 mb-2" maxlength="10">
    <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="w-full border p-2 mb-2">
    <input id="author" placeholder="è‘—è€…" class="w-full border p-2 mb-2">
    <input type="hidden" id="cover">

    <div id="preview" class="h-32 border flex items-center justify-center mb-3 text-slate-400">
      No Image
    </div>

    <div class="flex gap-2">
      <button onclick="closeModal()" class="flex-1 border p-2 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button onclick="saveBook()" class="flex-1 bg-slate-800 text-white p-2 rounded">ä¿å­˜</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  query, orderBy, doc, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
  authDomain: "library-management-tool-31dcd.firebaseapp.com",
  projectId: "library-management-tool-31dcd"
});
const db = getFirestore(app);

const grid = document.getElementById("grid");
const toggleInventory = document.getElementById("toggleInventory");
const scannerBox = document.getElementById("scannerBox");

let books = [];
let inventoryMode = false;
let scanning = false;

/* Firestore */
onSnapshot(
  query(collection(db,"books"), orderBy("updatedAt","desc")),
  snap=>{
    books = snap.docs.map(d=>({id:d.id,...d.data()}));
    render();
  }
);

/* ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°åˆ†å² */
function render(){
  grid.innerHTML="";
  inventoryMode ? renderInventory() : renderNormal();
}

/* é€šå¸¸è¡¨ç¤º */
function renderNormal(){
  books.forEach(b=>{
    grid.innerHTML+=`
    <div class="bg-white rounded shadow p-2">
      <div class="h-32 bg-slate-100 flex items-center justify-center mb-2">
        ${b.cover?`<img src="${b.cover}" class="h-full object-contain">`:"No Image"}
      </div>
      <p class="font-bold text-sm">${b.title||""}</p>
      <p class="text-xs text-slate-500">${b.author||""}</p>
      <p class="text-[10px] mt-1">ç®¡ç†ç•ªå·:${b.mcNumber||"-"}</p>
      <div class="flex gap-1 mt-2 text-xs">
        <button onclick="editBook('${b.id}')" class="flex-1 border rounded">ç·¨é›†</button>
        <button onclick="deleteBook('${b.id}')" class="flex-1 border rounded text-red-500">å‰Šé™¤</button>
      </div>
    </div>`;
  });
}

/* æ£šå¸è¡¨ç¤º */
function renderInventory(){
  books.filter(b=>!b.inventoryCheckedAt).forEach(b=>{
    grid.innerHTML+=`
    <div class="bg-yellow-50 border border-yellow-300 p-2 rounded">
      <p class="font-bold text-sm">${b.title||""}</p>
      <p class="text-xs text-slate-600">${b.author||""}</p>
      <p class="text-xs text-red-500 mt-1">æœªæ£šå¸</p>
    </div>`;
  });
}

/* æ£šå¸ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ */
toggleInventory.onchange=()=>{
  inventoryMode = toggleInventory.checked;
  scannerBox.classList.toggle("hidden",!inventoryMode);
  inventoryMode ? startScanner() : stopScanner();
  render();
};

/* ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ */
function startScanner(){
  Quagga.init({
    inputStream:{type:"LiveStream",target:"#interactive",constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader"]}
  },err=>{
    if(err){alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—");return;}
    Quagga.start(); scanning=true;
  });
  Quagga.onDetected(async r=>{
    const code=r.codeResult.code;
    if(/^97[89]\d{10}$/.test(code)){
      const b=books.find(x=>x.isbn===code);
      if(b){
        await updateDoc(doc(db,"books",b.id),{
          inventoryCheckedAt:new Date(),
          updatedAt:new Date()
        });
      }else{
        alert("æœªç™»éŒ²ã®æ›¸ç±ã§ã™");
      }
    }
  });
}
function stopScanner(){
  if(scanning){Quagga.stop();Quagga.offDetected();}
  scanning=false;
}

/* CRUD */
window.saveBook=async()=>{
  if(!/^\d{10}$/.test(mc.value)){alert("ç®¡ç†ç•ªå·10æ¡");return;}
  await addDoc(collection(db,"books"),{
    isbn:isbn.value,
    mcNumber:mc.value,
    title:title.value,
    author:author.value,
    cover:cover.value,
    createdAt:new Date(),
    updatedAt:new Date()
  });
  closeModal();
};

window.editBook=id=>{
  const b=books.find(x=>x.id===id);
  if(!b)return;
  isbn.value=b.isbn||"";
  mc.value=b.mcNumber||"";
  title.value=b.title||"";
  author.value=b.author||"";
  cover.value=b.cover||"";
  preview.innerHTML=b.cover?`<img src="${b.cover}" class="h-full object-contain">`:"No Image";
  openModal();
};

window.deleteBook=async id=>{
  if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    await deleteDoc(doc(db,"books",id));
  }
};

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
window.openModal=()=>modal.classList.replace("hidden","flex");
window.closeModal=()=>modal.classList.replace("flex","hidden");
</script>
</body>
</html>
