<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">
<style>
body { font-family:'Noto Sans JP',sans-serif }
#interactive { height:260px; background:#000; border-radius:12px; overflow:hidden; position:relative }
#interactive video { width:100%; height:100%; object-fit:cover }
.scan-box { position:absolute; inset:20% 10%; border:2px solid red }
</style>
</head>
<body class="bg-slate-100 min-h-screen">

<header class="bg-white p-4 shadow flex justify-between items-center">
  <h1 class="font-bold text-xl">ğŸ“š è”µæ›¸ç®¡ç†</h1>
  <div class="flex gap-2">
    <button id="btnRegister" class="bg-slate-800 text-white px-4 py-2 rounded">ï¼‹ ç™»éŒ²</button>
    <button id="btnMode" class="bg-slate-200 px-3 py-2 rounded">æ£šå¸ãƒ¢ãƒ¼ãƒ‰</button>
  </div>
</header>

<main class="p-4">
  <div id="bookGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
</main>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
  <div class="bg-white w-full max-w-md rounded-xl p-4">
    <h2 class="font-bold mb-3">æ›¸ç±ç™»éŒ² / ç·¨é›†</h2>

    <button id="btnScan" class="w-full border rounded p-3 mb-3">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</button>
    <div id="scanner" class="hidden relative mb-3">
      <div id="interactive"><div class="scan-box"></div></div>
      <button id="btnCancelScan" class="w-full text-red-500 mt-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <input id="isbn" placeholder="ISBN" class="w-full border p-2 mb-2">
    <button id="btnLookup" class="w-full bg-slate-200 p-2 rounded mb-2">ISBNæƒ…å ±å–å¾—</button>

    <input id="mcNumber" placeholder="ç®¡ç†ç•ªå·ï¼ˆæ•°å­—10æ¡ï¼‰" class="w-full border p-2 mb-2" maxlength="10" inputmode="numeric">
    <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="w-full border p-2 mb-2">
    <input id="author" placeholder="è‘—è€…" class="w-full border p-2 mb-2">
    <input type="hidden" id="cover">
    <div id="coverPreview" class="h-40 border flex items-center justify-center mb-3 text-slate-400">No Image</div>

    <div class="flex gap-2">
      <button id="btnCancel" class="flex-1 border p-2 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="btnSave" class="flex-1 bg-slate-800 text-white p-2 rounded">ä¿å­˜</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  doc, updateDoc, deleteDoc, query, where, getDocs
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// Firebase åˆæœŸåŒ–
const app = initializeApp({
  apiKey: "AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
  authDomain: "library-management-tool-31dcd.firebaseapp.com",
  projectId: "library-management-tool-31dcd"
});
const db = getFirestore(app);

// DOM
const grid = document.getElementById("bookGrid");
const modal = document.getElementById("modal");
const isbn = document.getElementById("isbn");
const mcNumber = document.getElementById("mcNumber");
const title = document.getElementById("title");
const author = document.getElementById("author");
const cover = document.getElementById("cover");
const coverPreview = document.getElementById("coverPreview");
const btnSave = document.getElementById("btnSave");
const btnCancel = document.getElementById("btnCancel");
const btnRegister = document.getElementById("btnRegister");
const btnMode = document.getElementById("btnMode");
const btnScan = document.getElementById("btnScan");
const btnCancelScan = document.getElementById("btnCancel");
const btnLookup = document.getElementById("btnLookup");
const scanner = document.getElementById("scanner");

let books = [];
let editingId = null;
let mode = "é€šå¸¸"; // "æ£šå¸"
let scanning = false;

// Firestoreã‹ã‚‰å–å¾—
onSnapshot(collection(db,"books"), snap=>{
  books = snap.docs.map(d=>({id:d.id, ...d.data()}));
  render();
});

// æç”»
function render(){
  grid.innerHTML="";
  books.forEach(b=>{
    grid.innerHTML += `
      <div class="bg-white p-2 rounded shadow">
        <div class="h-32 bg-slate-100 mb-2 flex items-center justify-center">
          ${b.cover ? `<img src="${b.cover}" class="h-full object-contain">` : "No Image"}
        </div>
        <p class="font-bold text-sm">${b.title||""}</p>
        <p class="text-xs text-slate-400">${b.author||""}</p>
        <p class="text-[10px] text-slate-500 mt-1">ç®¡ç†ç•ªå·ï¼š${b.mcNumber||"â€”"}</p>
        <div class="flex gap-2 text-xs mt-2">
          <button class="editBtn flex-1 border rounded py-1" data-id="${b.id}">ç·¨é›†</button>
          <button class="delBtn flex-1 border rounded py-1 text-red-500" data-id="${b.id}">å‰Šé™¤</button>
        </div>
      </div>`;
  });

  // ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸
  document.querySelectorAll(".editBtn").forEach(b=>{
    b.addEventListener("click", e=>{ editBook(e.target.dataset.id); });
  });
  document.querySelectorAll(".delBtn").forEach(b=>{
    b.addEventListener("click", e=>{ deleteBook(e.target.dataset.id); });
  });
}

// ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
btnMode.addEventListener("click", ()=>{
  mode = mode==="é€šå¸¸" ? "æ£šå¸" : "é€šå¸¸";
  btnMode.textContent = mode==="é€šå¸¸" ? "æ£šå¸ãƒ¢ãƒ¼ãƒ‰" : "é€šå¸¸ãƒ¢ãƒ¼ãƒ‰";
  alert("ãƒ¢ãƒ¼ãƒ‰: "+mode);
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
btnRegister.addEventListener("click", openNewModal);
btnCancel.addEventListener("click", closeModal);

function openNewModal(){
  resetForm();
  modal.classList.remove("hidden");
}
function closeModal(){
  stopScanner();
  editingId=null;
  modal.classList.add("hidden");
}
function resetForm(){
  editingId=null;
  isbn.value=""; mcNumber.value=""; title.value=""; author.value=""; cover.value="";
  coverPreview.innerHTML="No Image";
}

// ä¿å­˜
btnSave.addEventListener("click", async()=>{
  if(!/^\d{10}$/.test(mcNumber.value)){ alert("ç®¡ç†ç•ªå·ã¯æ•°å­—10æ¡"); return; }
  // é‡è¤‡ãƒã‚§ãƒƒã‚¯
  const q = query(collection(db,"books"), where("mcNumber","==",mcNumber.value));
  const snap = await getDocs(q);
  if(!snap.empty && (!editingId || snap.docs.some(d=>d.id!==editingId))){
    alert("ç®¡ç†ç•ªå·é‡è¤‡");
    return;
  }
  const data = { isbn:isbn.value, mcNumber:mcNumber.value, title:title.value, author:author.value, cover:cover.value, updatedAt:new Date() };
  if(editingId) await updateDoc(doc(db,"books",editingId),data);
  else await addDoc(collection(db,"books"), {...data, createdAt:new Date()});
  closeModal();
});

// ç·¨é›†
function editBook(id){
  const b = books.find(x=>x.id===id);
  if(!b) return;
  editingId=id;
  isbn.value=b.isbn||""; mcNumber.value=b.mcNumber||""; title.value=b.title||""; author.value=b.author||""; cover.value=b.cover||"";
  coverPreview.innerHTML=b.cover ? `<img src="${b.cover}" class="h-full w-full object-contain">` : "No Image";
  modal.classList.remove("hidden");
}

// å‰Šé™¤
async function deleteBook(id){
  if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) await deleteDoc(doc(db,"books",id));
}

// ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
btnScan.addEventListener("click", toggleScanner);
btnCancelScan.addEventListener("click", stopScanner);

function toggleScanner(){ scanning ? stopScanner() : startScanner(); }

function startScanner(){
  scanner.classList.remove("hidden");
  Quagga.init({
    inputStream:{type:"LiveStream", target:"#interactive", constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader"]}}, err=>{
      if(err){ alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—"); return; }
      Quagga.start(); scanning=true;
    });
  Quagga.onDetected(r=>{
    const c=r.codeResult.code;
    if(/^97[89]\d{10}$/.test(c)){
      if(mode==="æ£šå¸"){
        // æ£šå¸ãƒ¢ãƒ¼ãƒ‰ãªã‚‰æ›´æ–°
        const b = books.find(x=>x.isbn===c);
        if(b) await updateDoc(doc(db,"books",b.id),{ lastCounted:new Date() });
      } else {
        isbn.value=c;
        stopScanner();
        lookupISBN();
      }
    }
  });
}

function stopScanner(){ if(scanning){ Quagga.stop(); Quagga.offDetected(); } scanning=false; scanner.classList.add("hidden"); }

// ISBNå–å¾—
btnLookup.addEventListener("click", lookupISBN);
async function lookupISBN(){
  const i=isbn.value.replace(/\D/g,"");
  if(!i) return;
  let t="",a="",c="";
  try{
    const r = await fetch(`https://api.openbd.jp/v1/get?isbn=${i}`);
    const d = await r.json();
    if(d[0]?.summary){ t=d[0].summary.title||""; a=d[0].summary.author||""; c=d[0].summary.cover||""; }
    if(!c){
      const gr=await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${i}`);
      const gd=await gr.json();
      c = gd.items?.[0]?.volumeInfo?.imageLinks?.thumbnail||"";
      if(!t) t=gd.items?.[0]?.volumeInfo?.title||"";
      if(!a) a=gd.items?.[0]?.volumeInfo?.authors?.join(", ")||"";
    }
    if(c.startsWith("http://")) c=c.replace("http://","https://");
    title.value=t; author.value=a; cover.value=c;
    coverPreview.innerHTML=c ? `<img src="${c}" class="h-full w-full object-contain">` : "è¡¨ç´™ãªã—";
  }catch(e){ alert("æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼"); console.error(e); }
}
</script>

</body>
</html>
