<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>è”µæ›¸ç®¡ç†</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
body { background:#f0f4f8; }
#interactive { height:200px; background:#000; border-radius:12px; overflow:hidden }
.scan-overlay { position:absolute; inset:20% 10%; border:2px solid red }
</style>
</head>

<body class="min-h-screen">

<header class="bg-white shadow sticky top-0 z-10">
  <div class="px-4 h-14 flex items-center justify-between">
    <h1 class="font-bold">ğŸ“š è”µæ›¸ç®¡ç†</h1>
    <button onclick="openModal()"
      class="hidden md:inline bg-slate-700 text-white px-4 py-2 rounded">
      ï¼‹ ç™»éŒ²
    </button>
  </div>
</header>

<main class="p-4">
  <div id="book-grid" class="grid gap-4"></div>
  <p id="empty" class="text-center text-gray-400 hidden">æ›¸ç±ãŒã‚ã‚Šã¾ã›ã‚“</p>
</main>

<!-- ãƒ¢ãƒã‚¤ãƒ«FAB -->
<button onclick="openModal()"
  class="md:hidden fixed bottom-6 right-6 z-40
         w-16 h-16 rounded-full bg-slate-700 text-white text-3xl shadow-lg">
  ï¼‹
</button>

<!-- ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden z-50">
  <div class="bg-white w-full h-full overflow-y-auto pb-32">

    <div class="p-4">
      <h2 class="font-bold mb-2">æ›¸ç±ç™»éŒ²</h2>

      <button onclick="toggleScanner()"
        class="border-dashed border w-full py-2 mb-2">
        ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
      </button>

      <div id="scanner" class="hidden mb-2 relative">
        <div id="interactive"><div class="scan-overlay"></div></div>
        <button onclick="stopScanner()" class="text-sm text-red-500">é–‰ã˜ã‚‹</button>
      </div>

      <!-- è¡¨ç´™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div id="cover-preview"
        class="w-full h-48 bg-gray-100 flex items-center justify-center text-gray-400 mb-3 rounded">
        è¡¨ç´™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      </div>

      <!-- ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå…¥åŠ›ã®ã¿ï¼‰ -->
      <form id="book-form" class="space-y-2">
        <input id="isbn" placeholder="ISBN"
          class="border w-full px-3 py-2 rounded">
        <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«*"
          required class="border w-full px-3 py-2 rounded">
        <input id="author" placeholder="è‘—è€…"
          class="border w-full px-3 py-2 rounded">
      </form>
    </div>
  </div>

  <!-- å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆformå¤–ãƒ»iOSå¯¾å¿œï¼‰ -->
  <div class="fixed bottom-0 left-0 right-0 bg-white p-4 z-50 flex gap-2">
    <button onclick="closeModal()"
      class="flex-1 border py-3 rounded">
      ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    </button>
    <button onclick="submitBook()"
      class="flex-1 bg-slate-700 text-white rounded font-bold">
      ç™»éŒ²
    </button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
  authDomain: "library-management-tool-31dcd.firebaseapp.com",
  projectId: "library-management-tool-31dcd"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
signInAnonymously(auth);

/* DOM */
const grid = document.getElementById('book-grid');
const empty = document.getElementById('empty');
const isbn = document.getElementById('isbn');
const title = document.getElementById('title');
const author = document.getElementById('author');

/* ä¸€è¦§ */
onSnapshot(collection(db,"books"), snap=>{
  grid.innerHTML="";
  if(snap.empty){ empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');

  snap.forEach(d=>{
    const b=d.data();
    const div=document.createElement('div');
    div.className="bg-white p-3 rounded shadow";
    div.innerHTML=`
      <img src="${b.coverUrl||''}" class="h-40 w-full object-contain mb-2"
        onerror="this.style.display='none'">
      <p class="font-bold">${b.title}</p>
      <p class="text-sm">${b.author||''}</p>
    `;
    grid.appendChild(div);
  });
});

/* ISBNè‡ªå‹•å–å¾— */
async function autofill(isbnVal){
  if(!isbnVal) return;
  const res = await fetch(
    `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbnVal}`
  );
  const data = await res.json();
  const info = data.items?.[0]?.volumeInfo;
  if(!info) return;

  if(info.title) title.value = info.title;
  if(info.authors) author.value = info.authors.join(" / ");

  const img = info.imageLinks?.thumbnail;
  if(img){
    const url = img.replace("http://","https://").replace("zoom=1","zoom=2");
    isbn.dataset.cover = url;
    document.getElementById('cover-preview').innerHTML =
      `<img src="${url}" class="h-full object-contain">`;
  }
}

isbn.addEventListener('change', e=>{
  autofill(e.target.value.replace(/[^0-9]/g,''));
});

/* ã‚¹ã‚­ãƒ£ãƒŠ */
let scanning=false;
window.toggleScanner=()=>{
  document.getElementById('scanner').classList.remove('hidden');
  Quagga.init({
    inputStream:{type:"LiveStream",target:"#interactive",
      constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader"]}
  },()=>{
    Quagga.start();
    scanning=true;
    Quagga.onDetected(r=>{
      const code=r.codeResult.code;
      if(/^97[89]/.test(code)){
        isbn.value=code;
        autofill(code);
        stopScanner();
      }
    });
  });
};
window.stopScanner=()=>{
  if(scanning){Quagga.stop();Quagga.offDetected();}
  document.getElementById('scanner').classList.add('hidden');
};

/* ç™»éŒ²ï¼ˆformå¤–ã‹ã‚‰submitï¼‰ */
window.submitBook = async () => {
  if(!title.value){
    alert("ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™");
    return;
  }
  const cover =
    isbn.dataset.cover ||
    `https://covers.openlibrary.org/b/isbn/${isbn.value}-L.jpg`;

  await addDoc(collection(db,"books"),{
    isbn:isbn.value,
    title:title.value,
    author:author.value,
    coverUrl:cover,
    createdAt:serverTimestamp()
  });

  closeModal();
  document.getElementById('book-form').reset();
  document.getElementById('cover-preview').textContent="è¡¨ç´™ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼";
};

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
window.openModal=()=>modal.classList.remove('hidden');
window.closeModal=()=>modal.classList.add('hidden');
</script>

</body>
</html>
