async function startScanner(){
  stopScanner();

  $("scannerBox").classList.remove("hidden");

  // ★ Safari対策：DOM反映を確実に待つ
  await new Promise(resolve => requestAnimationFrame(resolve));
  await new Promise(resolve => setTimeout(resolve, 50));

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });

    const video = $("video");
    video.srcObject = stream;

    // ★ iOS Safari 必須
    video.setAttribute("playsinline", "");
    video.muted = true;

    await video.play();

    const devices = await BrowserMultiFormatReader.listVideoInputDevices();
    const backCam =
      devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];

    controls = await reader.decodeFromVideoDevice(
      backCam.deviceId,
      video,
      result => {
        if (result) {
          const code = result.getText();
          if (/^97[89]\d{10}$/.test(code)) {
            $("isbnInput").value = code;
            stopScanner();
            lookupISBN(code);
          }
        }
      }
    );

  } catch (err) {
    alert("カメラを起動できません（Safari設定を確認してください）");
    stopScanner();
  }
}
