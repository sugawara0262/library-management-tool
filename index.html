<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Pro</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

<style>
body { font-family:'Noto Sans JP',sans-serif; background:#f8fafc; }
.line-clamp-2{
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}
#video{
  width:100%;
  height:240px;
  object-fit:cover;
  border-radius:12px;
  background:#000;
}
.scan-overlay{
  position:absolute;
  inset:20% 10%;
  border:2px solid #ef4444;
  pointer-events:none;
}
</style>
</head>

<body class="min-h-screen flex flex-col">

<header class="bg-white border-b sticky top-0 z-50">
  <div class="px-4 h-16 flex items-center">
    <h1 class="font-bold text-xl">ğŸ“š è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
  </div>
</header>

<main class="flex-grow px-4 py-6 max-w-7xl mx-auto w-full">

<div class="flex gap-4 mb-6">
  <input id="search-input" placeholder="æ¤œç´¢"
    class="flex-grow px-4 py-3 border rounded-xl">
  <button onclick="openModal()"
    class="bg-slate-800 text-white px-6 rounded-xl font-bold">ï¼‹ æ–°è¦ç™»éŒ²</button>
</div>

<div id="book-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

</main>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
<div class="bg-white w-full max-w-lg rounded-2xl p-6">

<div class="flex justify-between mb-4">
  <h2 class="font-bold text-xl">æ›¸ç±ç™»éŒ²</h2>
  <button onclick="closeModal()">âœ•</button>
</div>

<button onclick="startScanner()"
  class="w-full border-2 border-dashed rounded-xl py-4 mb-4 font-bold">
  ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
</button>

<div id="scanner" class="hidden relative mb-4">
  <video id="video" playsinline muted></video>
  <div class="scan-overlay"></div>
  <button onclick="stopScanner()"
    class="w-full text-center text-red-500 font-bold mt-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<input id="isbn" placeholder="ISBN" class="w-full border px-4 py-2 rounded-xl mb-2">
<input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="w-full border px-4 py-2 rounded-xl mb-2">
<input id="author" placeholder="è‘—è€…" class="w-full border px-4 py-2 rounded-xl mb-4">

<button onclick="addBook()"
  class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">
  ç™»éŒ²
</button>

</div>
</div>

<script type="module">
import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.4/+esm";

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
  authDomain:"library-management-tool-31dcd.firebaseapp.com",
  projectId:"library-management-tool-31dcd"
};

initializeApp(firebaseConfig);
signInAnonymously(getAuth());
const db=getFirestore();

let books=[];
const reader=new BrowserMultiFormatReader();
let controls=null;

onSnapshot(collection(db,"books"),snap=>{
  books=snap.docs.map(d=>d.data());
  render();
});

function render(){
  const g=document.getElementById("book-grid");
  g.innerHTML="";
  books.forEach(b=>{
    g.innerHTML+=`
      <div class="bg-white p-4 rounded-xl shadow">
        <h3 class="font-bold line-clamp-2">${b.title}</h3>
        <p class="text-sm text-slate-400">${b.author}</p>
        <p class="text-xs text-slate-300">${b.isbn}</p>
      </div>`;
  });
}

window.openModal=()=>modal.classList.replace("hidden","flex");
window.closeModal=()=>{ stopScanner(); modal.classList.replace("flex","hidden"); };

window.startScanner=async()=>{
  document.getElementById("scanner").classList.remove("hidden");
  controls=await reader.decodeFromVideoDevice(
    { facingMode:"environment" },
    document.getElementById("video"),
    (res)=>{
      if(res){
        const code=res.getText();
        if(/^97[89]\d{10}$/.test(code)){
          isbn.value=code;
          stopScanner();
          lookupISBN(code);
        }
      }
    }
  );
};

window.stopScanner=()=>{
  if(controls){ controls.stop(); controls=null; }
  document.getElementById("scanner").classList.add("hidden");
};

async function lookupISBN(code){
  const r=await fetch(`https://api.openbd.jp/v1/get?isbn=${code}`);
  const d=await r.json();
  if(d[0]){
    title.value=d[0].summary.title||"";
    author.value=d[0].summary.author||"";
  }
}

window.addBook=async()=>{
  await addDoc(collection(db,"books"),{
    isbn:isbn.value,
    title:title.value,
    author:author.value
  });
  closeModal();
};
</script>

</body>
</html>
