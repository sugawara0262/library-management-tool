<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>書籍管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc,
  deleteDoc, updateDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ------------------ 状態 ------------------ */
let books = [];
let editingId = null;
let inventoryMode = false;

let lastScannedIsbn = null;
let lastScanTime = 0;

/* ------------------ DOM ------------------ */
const list = document.getElementById("list");

/* ------------------ Firestore ------------------ */
onSnapshot(collection(db, "books"), snap => {
  books = snap.docs.map(d => {
    const data = d.data();
    return { id: d.id, ...data };
  });
  render();
});

/* ------------------ 描画 ------------------ */
function render() {
  list.innerHTML = "";
  books.forEach(b => {
    const inv = b.inventory?.checked
      ? `<span class="text-green-600 text-sm">棚卸済（${new Date(b.inventory.lastCheckedAt.seconds*1000).toLocaleDateString()}）</span>`
      : `<span class="text-gray-400 text-sm">未棚卸</span>`;

    list.innerHTML += `
      <div class="border p-3 rounded flex gap-3">
        <img src="${b.cover || ''}" class="w-16 h-20 object-contain bg-gray-100">
        <div class="flex-1">
          <div class="font-bold">${b.title}</div>
          <div class="text-sm text-gray-600">${b.author || ""}</div>
          <div class="text-xs">ISBN: ${b.isbn}</div>
          ${inv}
        </div>
        <div class="flex flex-col gap-1">
          <button onclick="editBook('${b.id}')" class="text-blue-600 text-sm">編集</button>
          <button onclick="delBook('${b.id}')" class="text-red-600 text-sm">削除</button>
        </div>
      </div>
    `;
  });
}

/* ------------------ 登録 ------------------ */
async function saveBook() {
  const data = {
    isbn: isbn.value,
    title: title.value,
    author: author.value,
    cover: cover.value,
    createdAt: new Date()
  };

  if (editingId) {
    await updateDoc(doc(db, "books", editingId), data);
  } else {
    await addDoc(collection(db, "books"), data);
  }

  closeModal();
}

/* ------------------ 編集・削除 ------------------ */
window.editBook = id => {
  const b = books.find(x => x.id === id);
  editingId = id;
  isbn.value = b.isbn;
  title.value = b.title;
  author.value = b.author;
  cover.value = b.cover;
  openModal();
};

window.delBook = async id => {
  if (!confirm("削除しますか？")) return;
  await deleteDoc(doc(db, "books", id));
};

/* ------------------ 棚卸 ------------------ */
function canAcceptScan(isbn) {
  const now = Date.now();
  if (isbn === lastScannedIsbn && now - lastScanTime < 2000) return false;
  lastScannedIsbn = isbn;
  lastScanTime = now;
  return true;
}

async function inventoryCheck(isbn) {
  const book = books.find(b => b.isbn === isbn);
  if (!book) {
    toast("未登録の書籍", "error");
    return;
  }

  await updateDoc(doc(db, "books", book.id), {
    inventory: {
      checked: true,
      lastCheckedAt: new Date(),
      count: (book.inventory?.count || 0) + 1
    }
  });

  toast(`棚卸OK：${book.title}`, "ok");
}

/* ------------------ スキャン ------------------ */
function startScanner() {
  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: document.querySelector("#camera")
    },
    decoder: { readers: ["ean_reader"] }
  }, err => {
    if (!err) Quagga.start();
  });

  Quagga.onDetected(r => {
    const code = r.codeResult.code;
    if (!/^97[89]\d{10}$/.test(code)) return;
    if (!canAcceptScan(code)) return;

    if (inventoryMode) {
      inventoryCheck(code);
    } else {
      isbn.value = code;
    }
  });
}

function stopScanner() {
  Quagga.stop();
}

/* ------------------ UI補助 ------------------ */
function toast(msg, type) {
  const t = document.createElement("div");
  t.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-4 py-2 rounded text-white ${
    type === "ok" ? "bg-green-600" : "bg-red-600"
  }`;
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2000);
}

/* ------------------ モーダル ------------------ */
function openModal() {
  modal.classList.remove("hidden");
  startScanner();
}
function closeModal() {
  modal.classList.add("hidden");
  stopScanner();
  editingId = null;
}

/* ------------------ 棚卸モード切替 ------------------ */
window.toggleInventory = () => {
  inventoryMode = !inventoryMode;
  toast(inventoryMode ? "棚卸モードON" : "棚卸モードOFF", "ok");
};

</script>
</head>

<body class="p-4 bg-gray-50">

<header class="flex justify-between mb-4">
  <h1 class="text-xl font-bold">書籍管理</h1>
  <div class="flex gap-2">
    <button onclick="toggleInventory()" class="px-3 py-1 bg-orange-500 text-white rounded">
      棚卸モード
    </button>
    <button onclick="openModal()" class="px-3 py-1 bg-slate-800 text-white rounded">
      ＋ 登録
    </button>
  </div>
</header>

<div id="list" class="space-y-3"></div>

<!-- モーダル -->
<div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center">
  <div class="bg-white p-4 w-full max-w-md rounded space-y-2">
    <div id="camera" class="w-full h-40 bg-black"></div>
    <input id="isbn" placeholder="ISBN" class="w-full border p-2">
    <input id="title" placeholder="タイトル" class="w-full border p-2">
    <input id="author" placeholder="著者" class="w-full border p-2">
    <input id="cover" placeholder="表紙URL" class="w-full border p-2">
    <div class="flex gap-2 justify-end">
      <button onclick="closeModal()" class="px-3 py-1 border rounded">閉じる</button>
      <button onclick="saveBook()" class="px-3 py-1 bg-blue-600 text-white rounded">保存</button>
    </div>
  </div>
</div>

</body>
</html>
