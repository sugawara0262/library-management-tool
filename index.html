<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

<style>
body { font-family:'Noto Sans JP',sans-serif; background:#f0f4f8; }
.fade-in{ animation:fadeIn .25s ease; }
@keyframes fadeIn{ from{opacity:0;transform:translateY(6px)} to{opacity:1} }
#interactive{ height:240px; background:#000; border-radius:12px; overflow:hidden }
.scan-overlay{ position:absolute; inset:20% 10%; border:2px solid red; pointer-events:none }
</style>
</head>

<body class="min-h-screen flex flex-col">

<header class="bg-white shadow sticky top-0 z-10">
  <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
    <h1 class="font-bold text-xl">ğŸ“š è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
  </div>
</header>

<main class="flex-grow max-w-7xl mx-auto px-4 py-6 w-full">

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="bg-white p-4 rounded shadow"><p class="text-sm">ç·è”µæ›¸æ•°</p><p id="total-books" class="text-3xl font-bold">0</p></div>
  <div class="bg-white p-4 rounded shadow"><p class="text-sm">è²¸å‡ºå¯èƒ½</p><p id="available-books" class="text-3xl font-bold">0</p></div>
  <div class="bg-white p-4 rounded shadow"><p class="text-sm">è²¸å‡ºä¸­</p><p id="lent-books" class="text-3xl font-bold">0</p></div>
</div>

<div class="flex gap-3 mb-4">
  <input id="search-input" placeholder="æ¤œç´¢â€¦" class="flex-1 border px-3 py-2 rounded">
  <select id="filter-status" class="border px-3 py-2 rounded">
    <option value="all">å…¨ã¦</option>
    <option value="available">è²¸å‡ºå¯èƒ½</option>
    <option value="lent">è²¸å‡ºä¸­</option>
  </select>
  <button onclick="openModal()" class="bg-slate-700 text-white px-5 rounded">ï¼‹ ç™»éŒ²</button>
</div>

<div id="book-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
<div id="empty-state" class="hidden text-center py-10 text-gray-400">æ›¸ç±ãŒã‚ã‚Šã¾ã›ã‚“</div>

</main>

<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
  <div class="bg-white rounded p-6 w-full max-w-lg">
    <h2 class="font-bold text-lg mb-3">æ›¸ç±ç™»éŒ²</h2>

    <button id="start-scan-btn" onclick="toggleScanner()" class="border-dashed border w-full py-3 mb-3">
      ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
    </button>

    <div id="scanner-container" class="hidden mb-3 relative">
      <div id="interactive"><div class="scan-overlay"></div></div>
      <button onclick="stopScanner()" class="text-sm text-red-500 mt-1">é–‰ã˜ã‚‹</button>
    </div>

    <form id="add-book-form" class="space-y-3">
      <input id="isbn-input" placeholder="ISBN" class="border w-full px-3 py-2 rounded">
      <input id="mc-number" placeholder="MCç•ªå·ï¼ˆ10æ¡ï¼‰" class="border w-full px-3 py-2 rounded">
      <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«*" required class="border w-full px-3 py-2 rounded">
      <input id="author" placeholder="è‘—è€…" class="border w-full px-3 py-2 rounded">
      <textarea id="note" placeholder="å‚™è€ƒ" class="border w-full px-3 py-2 rounded"></textarea>

      <div class="flex gap-3">
        <button type="button" onclick="closeModal()" class="flex-1 border py-2 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="submit" class="flex-1 bg-slate-700 text-white rounded">ç™»éŒ²</button>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-4 py-2 rounded opacity-0 transition">
  <span id="toast-message"></span>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, deleteDoc, onSnapshot, serverTimestamp, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ===== è¨­å®š ===== */
const GOOGLE_BOOKS_API_KEY = ""; // æœ¬ç•ªã¯è¨­å®šæ¨å¥¨ï¼ˆãªãã¦ã‚‚å‹•ãï¼‰
const firebaseConfig = {
  apiKey: "AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
  authDomain: "library-management-tool-31dcd.firebaseapp.com",
  projectId: "library-management-tool-31dcd"
};

/* ===== çŠ¶æ…‹ ===== */
let db, auth, books = [], isScanning = false;

/* ===== Utils ===== */
const normalizeISBN = v => (v || "").replace(/[^0-9]/g,'');

function showToast(msg){
  const t = document.getElementById('toast');
  document.getElementById('toast-message').textContent = msg;
  t.classList.remove('opacity-0');
  setTimeout(()=>t.classList.add('opacity-0'), 2200);
}

/* ===== è¡¨ç´™å–å¾—ï¼ˆGoogle â†’ OpenLibraryï¼‰ ===== */
async function fetchCoverByISBN(isbn){
  if(!isbn) return "";

  // â‘  Google Books
  try{
    const url = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}` +
      (GOOGLE_BOOKS_API_KEY ? `&key=${GOOGLE_BOOKS_API_KEY}` : "");
    const res = await fetch(url);
    const data = await res.json();
    const img =
      data.items?.[0]?.volumeInfo?.imageLinks?.thumbnail ||
      data.items?.[0]?.volumeInfo?.imageLinks?.smallThumbnail;
    if(img){
      return img.replace("zoom=1", "zoom=2");
    }
  }catch(e){
    console.warn("Google Books å¤±æ•—", e);
  }

  // â‘¡ Open Libraryï¼ˆå­˜åœ¨ç¢ºèªã—ãªã„ï¼‰
  return `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`;
}

/* ===== æç”» ===== */
function renderBooks(){
  const grid = document.getElementById('book-grid');
  grid.innerHTML = "";

  const q = document.getElementById('search-input').value.toLowerCase();
  const st = document.getElementById('filter-status').value;

  const filtered = books.filter(b =>
    (!q || (b.title||"").toLowerCase().includes(q)) &&
    (st === "all" || b.status === st)
  );

  document.getElementById('empty-state')
    .classList.toggle('hidden', filtered.length > 0);

  filtered.forEach(b => {
    const d = document.createElement('div');
    d.className = "bg-white p-4 rounded shadow fade-in";
    d.innerHTML = `
      ${b.coverUrl ? `
        <img src="${b.coverUrl}"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
             class="w-full h-48 object-contain mb-2 rounded">
        <div class="w-full h-48 bg-gray-100 hidden items-center justify-center text-xs text-gray-400 mb-2 rounded">
          è¡¨ç´™ãªã—
        </div>
      ` : `
        <div class="w-full h-48 bg-gray-100 flex items-center justify-center text-xs text-gray-400 mb-2 rounded">
          è¡¨ç´™ãªã—
        </div>
      `}
      <h3 class="font-bold">${b.title}</h3>
      <p class="text-sm">${b.author || ""}</p>
      <p class="text-xs text-gray-500">${b.isbn || ""}</p>
      <button onclick="deleteBook('${b.id}')" class="text-xs text-red-500 mt-2">å‰Šé™¤</button>
    `;
    grid.appendChild(d);
  });

  document.getElementById('total-books').textContent = books.length;
  document.getElementById('available-books').textContent = books.filter(b=>b.status==="available").length;
  document.getElementById('lent-books').textContent = books.filter(b=>b.status==="lent").length;
}

/* ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
window.openModal = () => document.getElementById('modal').classList.remove('hidden');
window.closeModal = () => { stopScanner(); document.getElementById('modal').classList.add('hidden'); };

/* ===== ã‚¹ã‚­ãƒ£ãƒŠ ===== */
function stopScanner(){
  if(isScanning){
    Quagga.stop();
    Quagga.offDetected();
  }
  isScanning = false;
  document.getElementById('scanner-container').classList.add('hidden');
  document.getElementById('start-scan-btn').classList.remove('hidden');
}

window.toggleScanner = () => {
  if(isScanning){ stopScanner(); return; }
  document.getElementById('scanner-container').classList.remove('hidden');
  document.getElementById('start-scan-btn').classList.add('hidden');

  Quagga.init({
    inputStream:{ type:"LiveStream", target:"#interactive", constraints:{ facingMode:"environment" } },
    decoder:{ readers:["ean_reader"] }
  }, err => {
    if(err){ showToast("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—"); return; }
    Quagga.start();
    isScanning = true;
    Quagga.offDetected();
    Quagga.onDetected(res => {
      const code = res.codeResult.code;
      if(/^97[89]\d{10}$/.test(code)){
        document.getElementById('isbn-input').value = code;
        showToast("ISBNå–å¾—: " + code);
        stopScanner();
      }
    });
  });
};

/* ===== CRUD ===== */
window.deleteBook = async id => {
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  await deleteDoc(doc(db, "books", id));
};

document.getElementById('add-book-form').addEventListener('submit', async e => {
  e.preventDefault();

  const isbn = normalizeISBN(document.getElementById('isbn-input').value);
  if(isbn && books.some(b => normalizeISBN(b.isbn) === isbn)){
    showToast("æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™");
    return;
  }

  const mc = document.getElementById('mc-number').value;
  if(mc && !/^\d{10}$/.test(mc)){
    showToast("MCç•ªå·ã¯10æ¡ã§ã™");
    return;
  }

  const coverUrl = await fetchCoverByISBN(isbn);

  await addDoc(collection(db, "books"), {
    isbn,
    mcNumber: mc,
    title: document.getElementById('title').value,
    author: document.getElementById('author').value || "ä¸æ˜",
    note: document.getElementById('note').value || "",
    coverUrl,
    status: "available",
    createdAt: serverTimestamp()
  });

  showToast("ç™»éŒ²ã—ã¾ã—ãŸ");
  e.target.reset();
  closeModal();
});

/* ===== Firebase ===== */
const app = initializeApp(firebaseConfig);
auth = getAuth(app);
db = getFirestore(app);

onAuthStateChanged(auth, u => {
  if(u){
    onSnapshot(collection(db, "books"), snap => {
      books = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      renderBooks();
    });
  }
});
signInAnonymously(auth);

document.getElementById('search-input').addEventListener('input', renderBooks);
document.getElementById('filter-status').addEventListener('change', renderBooks);
</script>

</body>
</html>
