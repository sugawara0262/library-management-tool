<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Proï¼ˆå®‰å®šç‰ˆï¼‰</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
#scanner video{width:100%;height:100%;object-fit:cover}
</style>
</head>

<body class="bg-slate-100">

<header class="bg-white shadow p-4 font-bold">
ğŸ“š è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Proï¼ˆå®‰å®šç‰ˆï¼‰
</header>

<main class="p-4 space-y-3">

<input id="searchInput" placeholder="ç®¡ç†ç•ªå·ãƒ»ISBNãƒ»ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢"
 class="w-full border p-2 rounded">

<div class="flex flex-wrap gap-2">
<button id="addBtn" class="bg-slate-800 text-white px-4 py-2 rounded">
ï¼‹ æ–°è¦ç™»éŒ²
</button>

<button id="csvOut" class="border px-4 py-2 rounded">CSVå‡ºåŠ›</button>

<label class="border px-4 py-2 rounded cursor-pointer">
CSVå–è¾¼
<input type="file" accept=".csv" hidden id="csvIn">
</label>
</div>

<div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

</main>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
<div class="bg-white p-4 rounded w-full max-w-md space-y-3 max-h-[90vh] overflow-y-auto">

<h2 class="font-bold">æ›¸ç±ç™»éŒ²</h2>

<button id="scanBtn" class="border w-full py-2 rounded">
ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
</button>

<div id="scanner" class="hidden h-48 bg-black rounded"></div>

<input id="mcNumber" placeholder="ç®¡ç†ç•ªå·ï¼ˆ10æ¡ï¼‰" class="border p-2 w-full rounded">
<input id="isbn" placeholder="ISBN" class="border p-2 w-full rounded">

<button id="isbnBtn" class="border w-full py-1 rounded">ISBNå–å¾—</button>

<input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="border p-2 w-full rounded">
<input id="author" placeholder="è‘—è€…" class="border p-2 w-full rounded">

<div class="space-y-2">
<div class="font-bold text-sm">è¡¨ç´™ç”»åƒ</div>

<div id="coverPreview"
 class="h-40 bg-slate-100 rounded flex items-center justify-center overflow-hidden">
<span class="text-slate-400">No Image</span>
</div>

<input id="coverInput" placeholder="è¡¨ç´™URL"
 class="border p-2 w-full rounded">

<label class="border p-2 rounded w-full block text-center cursor-pointer">
ğŸ“· ç”»åƒã‚’é¸æŠ
<input type="file" accept="image/*" hidden id="coverFile">
</label>
</div>

<div class="flex gap-2 pt-2">
<button id="cancelBtn" class="flex-1 border rounded py-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
<button id="saveBtn" class="flex-1 bg-slate-800 text-white rounded py-2">ä¿å­˜</button>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ===== Firebase ===== */
const app = initializeApp({
 apiKey:"AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
 authDomain:"library-management-tool-31dcd.firebaseapp.com",
 projectId:"library-management-tool-31dcd"
});
signInAnonymously(getAuth(app));
const db = getFirestore(app);

/* ===== State ===== */
let books = [];
const UI = { editingId:null, scanning:false, importing:false };

/* ===== Snapshot ===== */
onSnapshot(query(collection(db,"books"),orderBy("createdAt","desc")),snap=>{
 if(UI.importing) return;
 books = snap.docs.map(d=>({id:d.id,...d.data()}));
 renderBooks();
});

/* ===== Render ===== */
function renderBooks(){
 const q = searchInput.value;
 grid.innerHTML="";
 books.filter(b=>
  b.mcNumber?.includes(q)||
  b.isbn?.includes(q)||
  b.title?.includes(q)
 ).forEach(b=>{
  grid.innerHTML+=`
<div class="bg-white p-3 rounded shadow">
<div class="h-32 bg-slate-100 flex items-center justify-center mb-2">
${b.cover?`<img src="${b.cover}" class="h-full object-contain">`:"No Image"}
</div>
<p class="font-bold text-sm">${b.title}</p>
<p class="text-sm">${b.author||""}</p>
<p class="text-xs">ç®¡ç†ç•ªå·ï¼š${b.mcNumber}</p>
<div class="flex gap-2 mt-2 text-sm">
<button onclick="editBook('${b.id}')" class="border flex-1">ç·¨é›†</button>
<button onclick="removeBook('${b.id}')" class="border flex-1 text-red-500">å‰Šé™¤</button>
</div>
</div>`;
 });
}

/* ===== Modal ===== */
addBtn.onclick=()=>openModal();
cancelBtn.onclick=()=>closeModal();

function openModal(){
 modal.classList.replace("hidden","flex");
}
function closeModal(){
 modal.classList.replace("flex","hidden");
 stopScanner();
 UI.editingId=null;
 resetForm();
}

/* ===== CRUD ===== */
saveBtn.onclick=async()=>{
 if(!/^\d{10}$/.test(mcNumber.value)) return alert("ç®¡ç†ç•ªå·ã¯10æ¡");
 if(books.some(b=>b.mcNumber===mcNumber.value&&b.id!==UI.editingId))
  return alert("ç®¡ç†ç•ªå·é‡è¤‡");

 const data={
  mcNumber:mcNumber.value,
  isbn:isbn.value,
  title:title.value,
  author:author.value,
  cover:coverInput.value,
  updatedAt:new Date()
 };

 if(UI.editingId)
  await updateDoc(doc(db,"books",UI.editingId),data);
 else
  await addDoc(collection(db,"books"),{...data,createdAt:new Date()});

 closeModal();
};

window.editBook=id=>{
 const b=books.find(x=>x.id===id);
 UI.editingId=id;
 mcNumber.value=b.mcNumber;
 isbn.value=b.isbn;
 title.value=b.title;
 author.value=b.author;
 coverInput.value=b.cover||"";
 updateCover(b.cover||"");
 openModal();
};

window.removeBook=async id=>{
 if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))
  await deleteDoc(doc(db,"books",id));
};

/* ===== ISBN ===== */
isbnBtn.onclick=async()=>{
 const i=isbn.value.replace(/[^0-9]/g,"");
 const r=await fetch(`https://api.openbd.jp/v1/get?isbn=${i}`);
 const d=await r.json();
 if(d[0]){
  title.value=d[0].summary.title||"";
  author.value=d[0].summary.author||"";
  coverInput.value=d[0].summary.cover||"";
  updateCover(coverInput.value);
 }
};

/* ===== Cover ===== */
coverInput.oninput=()=>updateCover(coverInput.value);
coverFile.onchange=e=>{
 const r=new FileReader();
 r.onload=ev=>{
  coverInput.value=ev.target.result;
  updateCover(ev.target.result);
 };
 r.readAsDataURL(e.target.files[0]);
};
function updateCover(url){
 coverPreview.innerHTML=url?`<img src="${url}" class="h-full object-contain">`:"No Image";
}

/* ===== Scanner ===== */
scanBtn.onclick=()=>{
 if(UI.scanning) return;
 scanner.classList.remove("hidden");
 Quagga.init({
  inputStream:{
   type:"LiveStream",
   target:scanner,
   constraints:{facingMode:"environment"}
  },
  decoder:{readers:["ean_reader"]}
 },err=>{
  if(err) return alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—");
  Quagga.start();
  UI.scanning=true;
 });
 Quagga.onDetected(r=>{
  const c=r.codeResult.code;
  if(/^97[89]\d{10}$/.test(c)){
   isbn.value=c;
   stopScanner();
   isbnBtn.onclick();
  }
 });
};
function stopScanner(){
 if(UI.scanning){
  Quagga.stop();
  Quagga.offDetected();
 }
 UI.scanning=false;
 scanner.classList.add("hidden");
}

/* ===== CSV ===== */
csvOut.onclick=()=>{
 let csv="ç®¡ç†ç•ªå·,ISBN,ã‚¿ã‚¤ãƒˆãƒ«,è‘—è€…,è¡¨ç´™\n";
 books.forEach(b=>csv+=`${b.mcNumber},${b.isbn},${b.title},${b.author},${b.cover||""}\n`);
 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv]));
 a.download="books.csv";
 a.click();
};

csvIn.onchange=async e=>{
 UI.importing=true;
 const text=await e.target.files[0].text();
 for(const l of text.split("\n").slice(1)){
  if(!l.trim()) continue;
  const [mc,isbn,title,author,cover]=l.split(",");
  if(!/^\d{10}$/.test(mc)) continue;
  if(books.some(b=>b.mcNumber===mc)) continue;
  await addDoc(collection(db,"books"),{
   mcNumber:mc,isbn,title,author,cover,createdAt:new Date()
  });
 }
 UI.importing=false;
 alert("CSVå–è¾¼å®Œäº†");
};

/* ===== Utils ===== */
function resetForm(){
 mcNumber.value=isbn.value=title.value=author.value=coverInput.value="";
 updateCover("");
}
searchInput.oninput=renderBooks;
</script>

</body>
</html>
