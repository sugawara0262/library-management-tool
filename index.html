<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>è”µæ›¸ç®¡ç†ï¼‹æ£šå¸</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- QuaggaJS -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ğŸ”´ ã‚ãªãŸã®Firebaseè¨­å®šã«å·®ã—æ›¿ãˆ */
const firebaseConfig = {
  apiKey: "XXXX",
  authDomain: "XXXX",
  projectId: "XXXX",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =========================
   çŠ¶æ…‹
========================= */
let books = [];
let inventoryMode = false;

/* =========================
   DOM
========================= */
const grid = document.getElementById("grid");
const toggleInventory = document.getElementById("inventoryToggle");
const scannerBox = document.getElementById("scanner");

/* =========================
   ISBNæ¤œç´¢ï¼ˆç”»åƒä¿®æ­£ç‰ˆï¼‰
========================= */
window.fetchFromISBN = async ()=>{
  const isbn = document.getElementById("isbn").value.trim();
  if(!isbn) return alert("ISBNã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
  const data = await res.json();

  if(!data.items){
    alert("æ›¸ç±æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  const v = data.items[0].volumeInfo;
  document.getElementById("title").value = v.title || "";
  document.getElementById("author").value = (v.authors||[]).join(",");

  /* ğŸ”§ ç”»åƒå–å¾— ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ */
  let img = "";
  if(v.imageLinks){
    img = v.imageLinks.thumbnail || v.imageLinks.smallThumbnail || "";
    img = img.replace("http://","https://");
  }
  document.getElementById("cover").value = img;
};

/* =========================
   ç®¡ç†ç•ªå·é‡è¤‡ãƒã‚§ãƒƒã‚¯
========================= */
async function checkDuplicate(mc){
  const q = query(collection(db,"books"),where("mcNumber","==",mc));
  const snap = await getDocs(q);
  return !snap.empty;
}

/* =========================
   ç™»éŒ²
========================= */
window.addBook = async ()=>{
  const mc = document.getElementById("mcNumber").value.trim();
  if(!/^\d{10}$/.test(mc)) return alert("ç®¡ç†ç•ªå·ã¯10æ¡æ•°å­—");

  if(await checkDuplicate(mc)){
    return alert("ç®¡ç†ç•ªå·ãŒé‡è¤‡ã—ã¦ã„ã¾ã™");
  }

  await addDoc(collection(db,"books"),{
    mcNumber: mc,
    isbn: document.getElementById("isbn").value,
    title: document.getElementById("title").value,
    author: document.getElementById("author").value,
    cover: document.getElementById("cover").value,
    inventoryCheckedAt: null
  });
  load();
};

/* =========================
   èª­ã¿è¾¼ã¿
========================= */
async function load(){
  const snap = await getDocs(collection(db,"books"));
  books = snap.docs.map(d=>({id:d.id,...d.data()}));
  render();
}

/* =========================
   æç”»
========================= */
function render(){
  grid.innerHTML="";
  inventoryMode ? renderInventory() : renderNormal();
}

function renderNormal(){
  books.forEach(b=>{
    grid.innerHTML+=`
    <div class="bg-white rounded shadow overflow-hidden">
      <div class="h-40 bg-gray-100 flex items-center justify-center">
        ${b.cover ? `<img src="${b.cover}" class="h-full object-contain">` : "No Image"}
      </div>
      <div class="p-2">
        <p class="font-bold text-sm">${b.title}</p>
        <p class="text-xs text-gray-500">${b.author}</p>
        <p class="text-[10px] mt-1">ç®¡ç†ç•ªå·ï¼š${b.mcNumber}</p>
      </div>
    </div>`;
  });
}

function renderInventory(){
  books.filter(b=>!b.inventoryCheckedAt).forEach(b=>{
    grid.innerHTML+=`
    <div class="border p-2 bg-yellow-50">
      <p class="font-bold text-sm">${b.title}</p>
      <p class="text-xs text-red-500">æœªæ£šå¸</p>
    </div>`;
  });
}

/* =========================
   æ£šå¸ã‚¹ã‚­ãƒ£ãƒ³
========================= */
function startScanner(){
  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:scannerBox,
      constraints:{facingMode:"environment"}
    },
    decoder:{readers:["ean_reader"]}
  },err=>{
    if(!err) Quagga.start();
  });

  Quagga.onDetected(async d=>{
    const code = d.codeResult.code;
    const hit = books.find(b=>b.isbn===code);
    if(hit){
      await updateDoc(doc(db,"books",hit.id),{
        inventoryCheckedAt:new Date()
      });
      load();
    }
  });
}

function stopScanner(){
  Quagga.stop();
}

/* =========================
   æ£šå¸åˆ‡æ›¿
========================= */
toggleInventory.onchange=()=>{
  inventoryMode = toggleInventory.checked;
  scannerBox.classList.toggle("hidden",!inventoryMode);
  inventoryMode ? startScanner() : stopScanner();
  render();
};

load();
</script>
</head>

<body class="bg-slate-100 p-4">
<h1 class="font-bold mb-2">ğŸ“š è”µæ›¸ç®¡ç†</h1>

<!-- ç™»éŒ²ç”»é¢ï¼ˆå®Œå…¨å¾©æ´»ï¼‰ -->
<div class="bg-white p-3 rounded shadow mb-4">
  <div class="flex gap-2">
    <input id="isbn" placeholder="ISBN" class="border p-1 flex-1">
    <button onclick="fetchFromISBN()" class="bg-blue-500 text-white px-2">å–å¾—</button>
  </div>
  <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="border p-1 w-full mt-1">
  <input id="author" placeholder="è‘—è€…" class="border p-1 w-full mt-1">
  <input id="cover" placeholder="ç”»åƒURL" class="border p-1 w-full mt-1">
  <input id="mcNumber" placeholder="ç®¡ç†ç•ªå·(10æ¡)" class="border p-1 w-full mt-1">
  <button onclick="addBook()" class="bg-green-600 text-white w-full mt-2">ç™»éŒ²</button>
</div>

<label class="flex items-center gap-2 mb-2">
  <input type="checkbox" id="inventoryToggle"> æ£šå¸ãƒ¢ãƒ¼ãƒ‰
</label>

<div id="scanner" class="hidden mb-2"></div>

<div id="grid" class="grid grid-cols-2 gap-2"></div>
</body>
</html>
