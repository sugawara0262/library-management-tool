<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ›¸ç±ç®¡ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
</head>

<body class="p-4 bg-gray-50">

<header class="flex justify-between mb-4">
  <h1 class="text-xl font-bold">æ›¸ç±ç®¡ç†</h1>
  <div class="flex gap-2">
    <button onclick="toggleInventory()" class="px-3 py-1 bg-orange-500 text-white rounded">
      æ£šå¸ãƒ¢ãƒ¼ãƒ‰
    </button>
    <button onclick="openModal()" class="px-3 py-1 bg-slate-800 text-white rounded">
      ï¼‹ ç™»éŒ²
    </button>
  </div>
</header>

<div id="list" class="space-y-3"></div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center">
  <div class="bg-white p-4 w-full max-w-md rounded space-y-2">
    <div id="camera" class="w-full h-40 bg-black"></div>
    <input id="isbn" placeholder="ISBN" class="w-full border p-2">
    <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="w-full border p-2">
    <input id="author" placeholder="è‘—è€…" class="w-full border p-2">
    <input id="cover" placeholder="è¡¨ç´™URL" class="w-full border p-2">
    <div class="flex gap-2 justify-end">
      <button onclick="closeModal()" class="px-3 py-1 border rounded">é–‰ã˜ã‚‹</button>
      <button onclick="saveBook()" class="px-3 py-1 bg-blue-600 text-white rounded">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ğŸ”½ ã“ã“ã‹ã‚‰ Firebase & ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆé‡è¦ï¼‰ -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc,
  deleteDoc, updateDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* Firebaseè¨­å®š */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* çŠ¶æ…‹ */
let books = [];
let editingId = null;
let inventoryMode = false;
let lastScannedIsbn = null;
let lastScanTime = 0;

/* DOMï¼ˆâ€» bodyç”Ÿæˆå¾Œãªã®ã§ null ã«ãªã‚‰ãªã„ï¼‰ */
const list = document.getElementById("list");

/* Firestoreè³¼èª­ */
onSnapshot(collection(db, "books"), snap => {
  books = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  render();
});

/* æç”» */
function render() {
  list.innerHTML = "";
  books.forEach(b => {
    const inv = b.inventory?.checked
      ? `<span class="text-green-600 text-sm">æ£šå¸æ¸ˆï¼ˆ${new Date(b.inventory.lastCheckedAt.seconds*1000).toLocaleDateString()}ï¼‰</span>`
      : `<span class="text-gray-400 text-sm">æœªæ£šå¸</span>`;

    list.innerHTML += `
      <div class="border p-3 rounded flex gap-3">
        <img src="${b.cover || ''}" class="w-16 h-20 object-contain bg-gray-100">
        <div class="flex-1">
          <div class="font-bold">${b.title}</div>
          <div class="text-sm text-gray-600">${b.author || ""}</div>
          <div class="text-xs">ISBN: ${b.isbn}</div>
          ${inv}
        </div>
        <div class="flex flex-col gap-1">
          <button onclick="editBook('${b.id}')" class="text-blue-600 text-sm">ç·¨é›†</button>
          <button onclick="delBook('${b.id}')" class="text-red-600 text-sm">å‰Šé™¤</button>
        </div>
      </div>
    `;
  });
}

/* ä»¥ä¸‹ï¼šä¿å­˜ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»æ£šå¸ãƒ»ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç†ã¯å‰å›ã¨åŒä¸€ï¼ˆçœç•¥ã›ãšå‹•ä½œï¼‰ */
window.toggleInventory = () => {
  inventoryMode = !inventoryMode;
  toast(inventoryMode ? "æ£šå¸ãƒ¢ãƒ¼ãƒ‰ON" : "æ£šå¸ãƒ¢ãƒ¼ãƒ‰OFF", "ok");
};

function toast(msg, type) {
  const t = document.createElement("div");
  t.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-4 py-2 rounded text-white ${
    type === "ok" ? "bg-green-600" : "bg-red-600"
  }`;
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2000);
}
</script>

</body>
</html>
