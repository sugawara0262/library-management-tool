<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Pro</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Quagga (ãƒãƒ¼ã‚³ãƒ¼ãƒ‰) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

<style>
body{font-family:'Noto Sans JP',sans-serif}
#interactive{height:260px;background:#000;border-radius:12px;overflow:hidden}
#interactive video{width:100%;height:100%;object-fit:cover}
.scan-box{position:absolute;inset:20% 10%;border:2px solid red}
</style>
</head>

<body class="bg-slate-100">

<header class="bg-white p-4 shadow flex justify-between">
  <h1 class="font-bold text-xl">ğŸ“š è”µæ›¸ç®¡ç†</h1>
  <button onclick="openModal()" class="bg-slate-800 text-white px-4 py-2 rounded">ï¼‹ç™»éŒ²</button>
</header>

<main class="p-4">
  <div id="bookGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
</main>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
<div class="bg-white w-full max-w-md rounded-xl p-4">

<h2 class="font-bold mb-2">æ›¸ç±ç™»éŒ²</h2>

<button onclick="startScanner()" class="w-full border rounded p-3 mb-3">
ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
</button>

<div id="scanner" class="hidden relative mb-3">
  <div id="interactive">
    <div class="scan-box"></div>
  </div>
  <button onclick="stopScanner()" class="text-red-500 w-full mt-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<input id="isbn" placeholder="ISBN" class="w-full border p-2 mb-2">
<button onclick="lookupISBN()" class="w-full bg-slate-200 p-2 rounded mb-2">ISBNå–å¾—</button>

<input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="w-full border p-2 mb-2">
<input id="author" placeholder="è‘—è€…" class="w-full border p-2 mb-2">
<input type="hidden" id="cover">

<div id="coverPreview" class="h-40 border flex items-center justify-center mb-2 text-slate-400">
No Image
</div>

<div class="flex gap-2">
<button onclick="closeModal()" class="flex-1 border p-2 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
<button onclick="addBook()" class="flex-1 bg-slate-800 text-white p-2 rounded">ç™»éŒ²</button>
</div>

</div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
  authDomain: "library-management-tool-31dcd.firebaseapp.com",
  projectId: "library-management-tool-31dcd"
});
const db = getFirestore(app);

const grid = document.getElementById("bookGrid");

onSnapshot(
  query(collection(db,"books"),orderBy("createdAt","desc")),
  snap=>{
    grid.innerHTML="";
    snap.forEach(d=>{
      const b=d.data();
      grid.innerHTML+=`
      <div class="bg-white p-2 rounded shadow">
        <div class="h-32 mb-2 bg-slate-100 flex items-center justify-center">
          ${b.cover?`<img src="${b.cover}" class="h-full">`:"No Image"}
        </div>
        <p class="font-bold text-sm">${b.title}</p>
        <p class="text-xs text-slate-400">${b.author}</p>
      </div>`;
    });
  }
);

window.addBook=async()=>{
  await addDoc(collection(db,"books"),{
    isbn:isbn.value,
    title:title.value,
    author:author.value,
    cover:cover.value,
    createdAt:new Date()
  });
  closeModal();
};
</script>

<script>
const $=id=>document.getElementById(id);
let scanning=false;

function openModal(){modal.classList.replace("hidden","flex")}
function closeModal(){stopScanner();modal.classList.replace("flex","hidden")}

function startScanner(){
  scanner.classList.remove("hidden");
  Quagga.init({
    inputStream:{type:"LiveStream",target:"#interactive",constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader"]}
  },err=>{
    if(err){alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—");return;}
    Quagga.start(); scanning=true;
  });
  Quagga.onDetected(r=>{
    const code=r.codeResult.code;
    if(/^97[89]\d{10}$/.test(code)){
      isbn.value=code;
      stopScanner();
      lookupISBN();
    }
  });
}

function stopScanner(){
  if(scanning){Quagga.stop();Quagga.offDetected();}
  scanning=false;
  scanner.classList.add("hidden");
}

async function lookupISBN(){
  const i=isbn.value.replace(/\D/g,"");
  let titleVal="",authorVal="",coverVal="";

  const r=await fetch(`https://api.openbd.jp/v1/get?isbn=${i}`);
  const d=await r.json();
  if(d[0]?.summary){
    titleVal=d[0].summary.title||"";
    authorVal=d[0].summary.author||"";
    coverVal=d[0].summary.cover||"";
  }

  if(!coverVal){
    const gr=await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${i}`);
    const gd=await gr.json();
    coverVal=gd.items?.[0]?.volumeInfo?.imageLinks?.thumbnail||"";
  }

  title.value=titleVal;
  author.value=authorVal;
  cover.value=coverVal;
  coverPreview.innerHTML=coverVal?`<img src="${coverVal}" class="h-full">`:"No Image";
}
</script>

</body>
</html>
