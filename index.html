<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Pro</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
#scanner video{width:100%;height:100%;object-fit:cover}
</style>
</head>

<body class="bg-slate-100">

<header class="bg-white shadow p-4 font-bold text-lg">
ğŸ“š è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Pro
</header>

<div class="p-4 space-y-3">

<input id="searchInput" placeholder="ç®¡ç†ç•ªå·ãƒ»ISBNãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã§æ¤œç´¢"
 class="w-full border p-2 rounded" oninput="renderBooks()">

<div class="flex flex-wrap gap-2">
<button onclick="openModal()" class="bg-slate-800 text-white px-4 py-2 rounded">
ï¼‹ æ–°è¦ç™»éŒ²
</button>

<button onclick="exportCSV()" class="border px-4 py-2 rounded">
CSVå‡ºåŠ›
</button>

<label class="border px-4 py-2 rounded cursor-pointer">
CSVå–è¾¼
<input type="file" accept=".csv" hidden onchange="importCSV(this)">
</label>
</div>

<div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
<div class="bg-white p-4 rounded w-full max-w-md space-y-3 max-h-[90vh] overflow-y-auto">

<h2 class="font-bold text-lg">æ›¸ç±ç™»éŒ²</h2>

<button onclick="startScanner()" class="border w-full py-2 rounded">
ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
</button>

<div id="scanner" class="hidden h-48 bg-black rounded"></div>

<input id="mcNumber" placeholder="ç®¡ç†ç•ªå·ï¼ˆ10æ¡ï¼‰" class="border p-2 w-full rounded">
<input id="isbn" placeholder="ISBN" class="border p-2 w-full rounded">

<button onclick="lookupISBN()" class="border w-full py-1 rounded">
ISBNã‹ã‚‰æƒ…å ±å–å¾—
</button>

<input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="border p-2 w-full rounded">
<input id="author" placeholder="è‘—è€…" class="border p-2 w-full rounded">

<!-- è¡¨ç´™ç”»åƒ -->
<div class="space-y-2">
  <div class="text-sm font-bold">è¡¨ç´™ç”»åƒ</div>

  <div id="coverPreview"
       class="h-40 bg-slate-100 rounded flex items-center justify-center overflow-hidden">
    <span class="text-slate-400 text-sm">No Image</span>
  </div>

  <input id="coverInput"
         placeholder="è¡¨ç´™ç”»åƒURLï¼ˆè‡ªå‹• / æ‰‹å‹•ï¼‰"
         class="border p-2 w-full rounded"
         oninput="updateCoverPreview(this.value)">

  <label class="border p-2 rounded w-full block text-center cursor-pointer">
    ğŸ“· ç”»åƒã‚’é¸æŠï¼ˆiPhoneå¯¾å¿œï¼‰
    <input type="file" accept="image/*" hidden onchange="uploadCover(this)">
  </label>
</div>

<input type="hidden" id="cover">

<div class="flex gap-2 pt-2">
<button onclick="closeModal()" class="flex-1 border rounded py-2">
ã‚­ãƒ£ãƒ³ã‚»ãƒ«
</button>
<button onclick="saveBook()" class="flex-1 bg-slate-800 text-white rounded py-2">
ä¿å­˜
</button>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
 authDomain:"library-management-tool-31dcd.firebaseapp.com",
 projectId:"library-management-tool-31dcd"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
signInAnonymously(auth);

let books=[],editingId=null;

onSnapshot(
 query(collection(db,"books"),orderBy("createdAt","desc")),
 snap=>{
  books=snap.docs.map(d=>({id:d.id,...d.data()}));
  renderBooks();
 }
);

window.renderBooks=()=>{
 const q=searchInput.value;
 grid.innerHTML="";
 books.filter(b=>
  b.mcNumber?.includes(q)||
  b.isbn?.includes(q)||
  b.title?.includes(q)
 ).forEach(b=>{
  grid.innerHTML+=`
<div class="bg-white p-3 rounded shadow">
<div class="h-32 bg-slate-100 flex justify-center items-center mb-2">
${b.cover?`<img src="${b.cover}" class="h-full object-contain">`:"No Image"}
</div>
<p class="font-bold text-sm">${b.title}</p>
<p class="text-sm">${b.author||""}</p>
<p class="text-xs text-slate-500">ç®¡ç†ç•ªå·ï¼š${b.mcNumber}</p>
<div class="flex gap-2 mt-2 text-sm">
<button onclick="editBook('${b.id}')" class="border flex-1">ç·¨é›†</button>
<button onclick="deleteBook('${b.id}')" class="border flex-1 text-red-500">å‰Šé™¤</button>
</div>
</div>`;
 });
};

window.openModal=()=>modal.classList.replace("hidden","flex");

window.closeModal=()=>{
 modal.classList.replace("flex","hidden");
 stopScanner();
 editingId=null;
 coverInput.value="";
 updateCoverPreview("");
};

window.editBook=id=>{
 const b=books.find(x=>x.id===id);
 editingId=id;
 mcNumber.value=b.mcNumber;
 isbn.value=b.isbn;
 title.value=b.title;
 author.value=b.author;
 cover.value=b.cover||"";
 coverInput.value=b.cover||"";
 updateCoverPreview(b.cover||"");
 openModal();
};

window.saveBook=async()=>{
 if(!/^\d{10}$/.test(mcNumber.value))
  return alert("ç®¡ç†ç•ªå·ã¯æ•°å­—10æ¡ã§ã™");

 if(books.some(b=>b.mcNumber===mcNumber.value&&b.id!==editingId))
  return alert("ç®¡ç†ç•ªå·ãŒé‡è¤‡ã—ã¦ã„ã¾ã™");

 const data={
  mcNumber:mcNumber.value,
  isbn:isbn.value,
  title:title.value,
  author:author.value,
  cover:cover.value,
  updatedAt:new Date()
 };

 if(editingId)
  await updateDoc(doc(db,"books",editingId),data);
 else
  await addDoc(collection(db,"books"),{...data,createdAt:new Date()});

 closeModal();
};

window.deleteBook=async id=>{
 if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))
  await deleteDoc(doc(db,"books",id));
};

window.lookupISBN=async()=>{
 const i=isbn.value.replace(/[^0-9]/g,"");
 if(!i)return;
 const r=await fetch(`https://api.openbd.jp/v1/get?isbn=${i}`);
 const d=await r.json();
 if(d[0]){
  title.value=d[0].summary.title||"";
  author.value=d[0].summary.author||"";
  const c=d[0].summary.cover||"";
  cover.value=c;
  coverInput.value=c;
  updateCoverPreview(c);
 }
};

window.updateCoverPreview=url=>{
 const p=coverPreview;
 p.innerHTML=url
  ? `<img src="${url}" class="h-full object-contain">`
  : `<span class="text-slate-400">No Image</span>`;
 cover.value=url;
};

window.uploadCover=input=>{
 const file=input.files[0];
 if(!file)return;
 const r=new FileReader();
 r.onload=e=>{
  cover.value=e.target.result;
  updateCoverPreview(e.target.result);
 };
 r.readAsDataURL(file);
};

let scanning=false;
window.startScanner=()=>{
 if(scanning)return;
 scanner.classList.remove("hidden");
 Quagga.init({
  inputStream:{
   type:"LiveStream",
   target:scanner,
   constraints:{facingMode:"environment"}
  },
  decoder:{readers:["ean_reader"]}
 },err=>{
  if(err)return alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—");
  Quagga.start();
  scanning=true;
 });
 Quagga.onDetected(r=>{
  const c=r.codeResult.code;
  if(/^97[89]\d{10}$/.test(c)){
   isbn.value=c;
   stopScanner();
   lookupISBN();
  }
 });
};

window.stopScanner=()=>{
 if(scanning){
  Quagga.stop();
  Quagga.offDetected();
 }
 scanning=false;
 scanner.classList.add("hidden");
};

window.exportCSV=()=>{
 let csv="ç®¡ç†ç•ªå·,ISBN,ã‚¿ã‚¤ãƒˆãƒ«,è‘—è€…,è¡¨ç´™\n";
 books.forEach(b=>{
  csv+=`${b.mcNumber},${b.isbn},${b.title},${b.author},${b.cover||""}\n`;
 });
 const a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
 a.download="books.csv";
 a.click();
};

window.importCSV=async input=>{
 const text=await input.files[0].text();
 for(const l of text.split("\n").slice(1)){
  if(!l.trim())continue;
  const [mc,isbn,title,author,cover]=l.split(",");
  if(!/^\d{10}$/.test(mc))continue;
  if(books.some(b=>b.mcNumber===mc))continue;
  await addDoc(collection(db,"books"),{
   mcNumber:mc,isbn,title,author,cover,
   createdAt:new Date()
  });
 }
 alert("CSVå–è¾¼å®Œäº†");
};
</script>

</body>
</html>
