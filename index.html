<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>蔵書管理＋棚卸</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

</head>
<body class="bg-slate-100">

<header class="bg-white shadow p-3 flex justify-between items-center">
  <h1 class="font-bold">蔵書管理</h1>

  <div class="flex gap-2 items-center">
    <label class="flex items-center gap-1 text-sm">
      <input type="checkbox" id="toggleInventory">
      棚卸モード
    </label>
    <button onclick="openModal()" class="bg-slate-800 text-white px-3 py-1 rounded">
      登録
    </button>
  </div>
</header>

<main class="p-4">
  <div id="scannerBox" class="hidden mb-4">
    <div id="interactive" class="h-56 bg-black rounded"></div>
    <p class="text-center text-sm text-slate-500 mt-1">
      実物のバーコードを読み取ってください
    </p>
  </div>

  <div id="bookGrid" class="grid grid-cols-2 sm:grid-cols-4 gap-3"></div>
</main>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden justify-center items-center">
  <div class="bg-white p-4 rounded w-80">
    <h2 class="font-bold mb-2">書籍登録</h2>

    <input id="inpIsbn" placeholder="ISBN13" class="w-full border p-1 mb-1">
    <input id="inpMc" placeholder="管理番号(10桁)" class="w-full border p-1 mb-1">
    <input id="inpTitle" placeholder="タイトル" class="w-full border p-1 mb-1">
    <input id="inpAuthor" placeholder="著者" class="w-full border p-1 mb-2">

    <div class="flex gap-2">
      <button onclick="closeModal()" class="flex-1 border">キャンセル</button>
      <button onclick="saveBook()" class="flex-1 bg-slate-800 text-white">保存</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  updateDoc, doc, query, orderBy, where, getDocs
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* Firebase */
const app = initializeApp({
  apiKey: "AIzaSyChSeXTRYpykQkMmcDj041nlq-Nkt03oC4",
  authDomain: "library-management-tool-31dcd.firebaseapp.com",
  projectId: "library-management-tool-31dcd"
});
const db = getFirestore(app);

/* State */
let books = [];
let inventoryMode = false;
let scanning = false;

/* DOM */
const grid = document.getElementById("bookGrid");
const scannerBox = document.getElementById("scannerBox");
const toggleInventory = document.getElementById("toggleInventory");

/* Firestore */
onSnapshot(
  query(collection(db,"books"),orderBy("updatedAt","desc")),
  snap=>{
    books = snap.docs.map(d=>({id:d.id,...d.data()}));
    render();
  }
);

/* Render */
function render(){
  grid.innerHTML="";
  books
    .filter(b=>{
      if(!inventoryMode) return true;
      return !b.inventoryCheckedAt;
    })
    .forEach(b=>{
      grid.innerHTML+=`
      <div class="bg-white p-2 rounded shadow">
        <p class="font-bold text-sm">${b.title||""}</p>
        <p class="text-xs text-slate-400">${b.author||""}</p>
        <p class="text-[11px] mt-1">
          ${b.inventoryCheckedAt
            ? "<span class='text-green-600'>棚卸済</span>"
            : "<span class='text-red-500'>未棚卸</span>"
          }
        </p>
      </div>`;
    });
}

/* 棚卸モード */
toggleInventory.onchange = ()=>{
  inventoryMode = toggleInventory.checked;
  inventoryMode ? startScanner() : stopScanner();
  scannerBox.classList.toggle("hidden",!inventoryMode);
  render();
};

/* Scanner */
function startScanner(){
  if(scanning) return;
  Quagga.init({
    inputStream:{
      name:"Live",
      type:"LiveStream",
      target:document.querySelector("#interactive"),
      constraints:{facingMode:"environment"}
    },
    decoder:{readers:["ean_reader"]}
  },err=>{
    if(err){alert("カメラ起動失敗");return;}
    Quagga.start();
    scanning=true;
  });

  Quagga.onDetected(async r=>{
    const isbn=r.codeResult.code;
    const q=query(collection(db,"books"),where("isbn","==",isbn));
    const snap=await getDocs(q);

    if(snap.empty){
      alert("未登録の書籍です");
      return;
    }

    snap.forEach(async d=>{
      await updateDoc(doc(db,"books",d.id),{
        inventoryCheckedAt:new Date(),
        updatedAt:new Date()
      });
    });
  });
}

function stopScanner(){
  if(scanning){
    Quagga.stop();
    Quagga.offDetected();
    scanning=false;
  }
}

/* Modal */
window.openModal=()=>{
  document.getElementById("modal").classList.remove("hidden");
};
window.closeModal=()=>{
  document.getElementById("modal").classList.add("hidden");
};

/* Save */
window.saveBook=async()=>{
  const isbn=inpIsbn.value.trim();
  const mc=inpMc.value.trim();
  const title=inpTitle.value.trim();

  if(!/^\d{10}$/.test(mc)){alert("管理番号10桁");return;}

  await addDoc(collection(db,"books"),{
    isbn,mcNumber:mc,title,
    author:inpAuthor.value.trim(),
    createdAt:new Date(),
    updatedAt:new Date()
  });
  closeModal();
};
</script>
</body>
</html>
