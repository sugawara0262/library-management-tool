<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>è”µæ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body { font-family: system-ui, -apple-system, BlinkMacSystemFont; }
#scanner video { width:100%; height:220px; object-fit:cover; }
</style>
</head>

<body class="bg-slate-100 min-h-screen">

<header class="bg-white shadow p-3 flex justify-between items-center">
  <h1 class="font-bold text-lg">ğŸ“š è”µæ›¸ç®¡ç†</h1>
  <button onclick="openModal()" class="bg-slate-800 text-white px-4 py-2 rounded">
    ï¼‹ ç™»éŒ²
  </button>
</header>

<main class="p-3">
  <div id="grid" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
</main>

<!-- ç™»éŒ²ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4 z-50">
  <div class="bg-white w-full max-w-md rounded-xl p-4">

    <h2 class="font-bold mb-3">æ›¸ç±ç™»éŒ² / ç·¨é›†</h2>

    <button onclick="toggleScanner()" class="w-full border rounded p-2 mb-2">
      ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³
    </button>

    <div id="scanner" class="hidden mb-2"></div>

    <input id="isbn" placeholder="ISBN" class="w-full border p-2 mb-2">
    <button onclick="lookupISBN()" class="w-full bg-slate-200 p-2 rounded mb-2">
      ISBNæƒ…å ±å–å¾—
    </button>

    <input id="mcNumber" placeholder="ç®¡ç†ç•ªå·ï¼ˆ10æ¡ï¼‰"
      class="w-full border p-2 mb-2" maxlength="10" inputmode="numeric">

    <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="w-full border p-2 mb-2">
    <input id="author" placeholder="è‘—è€…" class="w-full border p-2 mb-2">

    <input type="hidden" id="cover">
    <div id="coverPreview"
      class="h-40 border flex items-center justify-center mb-3 text-slate-400">
      No Image
    </div>

    <div class="flex gap-2">
      <button onclick="closeModal()" class="flex-1 border p-2 rounded">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
      <button onclick="saveBook()" class="flex-1 bg-slate-800 text-white p-2 rounded">
        ä¿å­˜
      </button>
    </div>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  doc, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* Firebaseè¨­å®šï¼ˆå·®ã—æ›¿ãˆï¼‰ */
const app = initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
});
const db = getFirestore(app);

/* DOM */
const grid = document.getElementById("grid");
const modal = document.getElementById("modal");
const isbn = document.getElementById("isbn");
const mcNumber = document.getElementById("mcNumber");
const title = document.getElementById("title");
const author = document.getElementById("author");
const cover = document.getElementById("cover");
const coverPreview = document.getElementById("coverPreview");
const scannerDiv = document.getElementById("scanner");

/* State */
let books = [];
let editingId = null;
let scanning = false;

/* ğŸ”¥ Firestoreç›£è¦–ï¼ˆorderByãªã—ï¼å¿…ãšè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰ */
onSnapshot(
  collection(db,"books"),
  snap=>{
    books = snap.docs.map(d=>({ id:d.id, ...d.data() }));

    // createdAt ãŒã‚ã‚‹ã‚‚ã®ã‚’å„ªå…ˆã—ã¦æ–°ã—ã„é †ã«ä¸¦ã¹ã‚‹
    books.sort((a,b)=>{
      const ta = a.createdAt?.seconds || 0;
      const tb = b.createdAt?.seconds || 0;
      return tb - ta;
    });

    render();
  }
);

/* æç”» */
function render(){
  grid.innerHTML = "";
  books.forEach(b=>{
    grid.innerHTML += `
    <div class="bg-white p-2 rounded shadow">
      <div class="h-32 bg-slate-100 mb-2 flex items-center justify-center">
        ${b.cover ? `<img src="${b.cover}" class="h-full object-contain">` : "No Image"}
      </div>
      <p class="font-bold text-sm">${b.title || ""}</p>
      <p class="text-xs text-slate-400">${b.author || ""}</p>
      <p class="text-[10px] text-slate-500 mt-1">
        ç®¡ç†ç•ªå·ï¼š${b.mcNumber || "-"}
      </p>
      <div class="flex gap-2 text-xs mt-2">
        <button onclick="editBook('${b.id}')" class="flex-1 border rounded py-1">
          ç·¨é›†
        </button>
        <button onclick="deleteBook('${b.id}')"
          class="flex-1 border rounded py-1 text-red-500">
          å‰Šé™¤
        </button>
      </div>
    </div>`;
  });
}

/* ä¿å­˜ */
window.saveBook = async () => {
  if(!/^\d{10}$/.test(mcNumber.value)){
    alert("ç®¡ç†ç•ªå·ã¯10æ¡æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const data = {
    isbn:isbn.value,
    mcNumber:mcNumber.value,
    title:title.value,
    author:author.value,
    cover:cover.value,
    updatedAt:new Date()
  };

  if(editingId){
    await updateDoc(doc(db,"books",editingId), data);
  }else{
    await addDoc(collection(db,"books"), {
      ...data,
      createdAt:new Date(),
      updatedAt:new Date()
    });
  }
  closeModal();
};

/* ç·¨é›† */
window.editBook = id => {
  const b = books.find(x=>x.id===id);
  if(!b) return;

  editingId = id;
  isbn.value=b.isbn||"";
  mcNumber.value=b.mcNumber||"";
  title.value=b.title||"";
  author.value=b.author||"";
  cover.value=b.cover||"";
  updateCoverPreview(b.cover);
  openModal();
};

/* å‰Šé™¤ */
window.deleteBook = async id => {
  if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    await deleteDoc(doc(db,"books",id));
  }
};

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
window.openModal = () => {
  modal.classList.replace("hidden","flex");
};
window.closeModal = () => {
  stopScanner();
  editingId=null;
  modal.classList.replace("flex","hidden");
};

/* ç”»åƒè¡¨ç¤º */
function updateCoverPreview(url){
  coverPreview.innerHTML = url
    ? `<img src="${url}" class="h-full w-full object-contain">`
    : "No Image";
}

/* ISBNå–å¾— */
window.lookupISBN = async ()=>{
  const i = isbn.value.replace(/\D/g,"");
  let c="";
  const r = await fetch(`https://api.openbd.jp/v1/get?isbn=${i}`);
  const d = await r.json();
  if(d[0]?.summary){
    title.value=d[0].summary.title||"";
    author.value=d[0].summary.author||"";
    c=d[0].summary.cover||"";
  }
  if(!c){
    const g = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${i}`);
    const gd = await g.json();
    c=gd.items?.[0]?.volumeInfo?.imageLinks?.thumbnail||"";
  }
  if(c.startsWith("http://")) c=c.replace("http://","https://");
  cover.value=c;
  updateCoverPreview(c);
};

/* Scanner */
window.toggleScanner = ()=> scanning ? stopScanner() : startScanner();
function startScanner(){
  scannerDiv.classList.remove("hidden");
  Quagga.init({
    inputStream:{type:"LiveStream",target:scannerDiv,constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader"]}
  },err=>{
    if(err){alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—");return;}
    Quagga.start(); scanning=true;
  });
  Quagga.onDetected(r=>{
    const code=r.codeResult.code;
    if(/^97[89]\d{10}$/.test(code)){
      isbn.value=code;
      stopScanner();
      lookupISBN();
    }
  });
}
function stopScanner(){
  if(scanning){Quagga.stop();Quagga.offDetected();}
  scanning=false;
  scannerDiv.classList.add("hidden");
}
</script>
</body>
</html>
